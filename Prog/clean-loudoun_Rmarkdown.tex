\documentclass[]{article}
\usepackage{lmodern}
\usepackage{amssymb,amsmath}
\usepackage{ifxetex,ifluatex}
\usepackage{fixltx2e} % provides \textsubscript
\ifnum 0\ifxetex 1\fi\ifluatex 1\fi=0 % if pdftex
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
\else % if luatex or xelatex
  \ifxetex
    \usepackage{mathspec}
  \else
    \usepackage{fontspec}
  \fi
  \defaultfontfeatures{Ligatures=TeX,Scale=MatchLowercase}
\fi
% use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
% use microtype if available
\IfFileExists{microtype.sty}{%
\usepackage{microtype}
\UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\usepackage[margin=1in]{geometry}
\usepackage{hyperref}
\hypersetup{unicode=true,
            pdftitle={Regional Housing Framework},
            pdfborder={0 0 0},
            breaklinks=true}
\urlstyle{same}  % don't use monospace font for urls
\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{248,248,248}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\ImportTok}[1]{#1}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\BuiltInTok}[1]{#1}
\newcommand{\ExtensionTok}[1]{#1}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.77,0.63,0.00}{#1}}
\newcommand{\RegionMarkerTok}[1]{#1}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.94,0.16,0.16}{#1}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.64,0.00,0.00}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{#1}
\usepackage{longtable,booktabs}
\usepackage{graphicx,grffile}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
\IfFileExists{parskip.sty}{%
\usepackage{parskip}
}{% else
\setlength{\parindent}{0pt}
\setlength{\parskip}{6pt plus 2pt minus 1pt}
}
\setlength{\emergencystretch}{3em}  % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\setcounter{secnumdepth}{0}
% Redefines (sub)paragraphs to behave more like sections
\ifx\paragraph\undefined\else
\let\oldparagraph\paragraph
\renewcommand{\paragraph}[1]{\oldparagraph{#1}\mbox{}}
\fi
\ifx\subparagraph\undefined\else
\let\oldsubparagraph\subparagraph
\renewcommand{\subparagraph}[1]{\oldsubparagraph{#1}\mbox{}}
\fi

%%% Use protect on footnotes to avoid problems with footnotes in titles
\let\rmarkdownfootnote\footnote%
\def\footnote{\protect\rmarkdownfootnote}

%%% Change title format to be more compact
\usepackage{titling}

% Create subtitle command for use in maketitle
\newcommand{\subtitle}[1]{
  \posttitle{
    \begin{center}\large#1\end{center}
    }
}

\setlength{\droptitle}{-2em}

  \title{Regional Housing Framework}
    \pretitle{\vspace{\droptitle}\centering\huge}
  \posttitle{\par}
  \subtitle{Clean Loudoun County public records data}
  \author{}
    \preauthor{}\postauthor{}
    \date{}
    \predate{}\postdate{}
  

\begin{document}
\maketitle

{
\setcounter{tocdepth}{2}
\tableofcontents
}
Library: RegHsg

Project: Regional Housing Framework

Author: Sarah Strochak

Version: R 3.5.1, RStudio 1.1.423

Last updated February 05, 2019

Environment: Local Windows session (desktop)

\subsection{Description}\label{description}

There are three main goals of the jurisdiction level cleaning process:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Recategorize the county land use codes into more general codes
\item
  Collapse observations at the address level
\item
  Clean the variables needed to provide density estimates
\end{enumerate}

\subsection{Set-up}\label{set-up}

\paragraph{Load libraries and
functions}\label{load-libraries-and-functions}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(tidyverse)}
\KeywordTok{library}\NormalTok{(DescTools)}
\KeywordTok{library}\NormalTok{(purrr)}

\KeywordTok{source}\NormalTok{(}\StringTok{"../Macros/read-bk.R"}\NormalTok{)}
\KeywordTok{source}\NormalTok{(}\StringTok{"../Macros/filter-bk.R"}\NormalTok{)}
\KeywordTok{source}\NormalTok{(}\StringTok{"../Macros/select-vars.R"}\NormalTok{)}
\KeywordTok{source}\NormalTok{(}\StringTok{"../Macros/sample-properties.R"}\NormalTok{)}
\KeywordTok{source}\NormalTok{(}\StringTok{"../Macros/classify-addresses.R"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\paragraph{Create directory for data
exports}\label{create-directory-for-data-exports}

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{if}\NormalTok{ (}\OperatorTok{!}\KeywordTok{dir.exists}\NormalTok{(}\StringTok{"Data"}\NormalTok{)) \{}
  \KeywordTok{dir.create}\NormalTok{(}\StringTok{"Data"}\NormalTok{)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\paragraph{Set FIPS code and filepath
name}\label{set-fips-code-and-filepath-name}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{currentfips <-}\StringTok{ "51107"}
\NormalTok{filepath <-}\StringTok{ "loudoun"}
\end{Highlighting}
\end{Shaded}

\paragraph{Load in Black Knight data for the region, select jurisdiction
and standard
variables}\label{load-in-black-knight-data-for-the-region-select-jurisdiction-and-standard-variables}

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{if}\NormalTok{ (}\OperatorTok{!}\KeywordTok{exists}\NormalTok{(}\StringTok{"region"}\NormalTok{)) \{}
\NormalTok{  region <-}\StringTok{ }\KeywordTok{read_bk}\NormalTok{(}\StringTok{"dc-cog-assessment_20181228.csv"}\NormalTok{)}
\NormalTok{\} }\ControlFlowTok{else}\NormalTok{ \{}
  \KeywordTok{warning}\NormalTok{(}\StringTok{"region data already read in"}\NormalTok{)}
\NormalTok{\}}

\NormalTok{jur <-}\StringTok{ }\NormalTok{region }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter_bk}\NormalTok{(}\DataTypeTok{fips =}\NormalTok{ currentfips) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{select_vars}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\subsection{Recategorize county land
use}\label{recategorize-county-land-use}

In order to complete the vacant land and soft site analysis, we will
need to break down properties into different classifications. This
process creates four variables:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  residential: 1 for residential, 0 for other.
\item
  category: categories are sf, mf, commercial, office, and vacant.
\item
  category\_detail: this will vary by jurisdiction, but includes the
  most detail possible to generalize from the county land use codes.
\item
  building\_type: this indicates the building type for multifamily
  parcels (condos and apartments)
\end{enumerate}

Export county land use codes for manual classification

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{currentjur_county <-}\StringTok{ }\NormalTok{jur }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{group_by}\NormalTok{(countylandusedescription) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{count}\NormalTok{()}

\ControlFlowTok{if}\NormalTok{ (}\OperatorTok{!}\KeywordTok{file.exists}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(}\StringTok{"../Data/"}\NormalTok{, filepath, }\StringTok{"-county-land-use.csv"}\NormalTok{))) \{}
  \KeywordTok{write_csv}\NormalTok{(currentjur_county,}
            \KeywordTok{paste0}\NormalTok{(}\StringTok{"../Data/"}\NormalTok{, filepath, }\StringTok{"-county-land-use.csv"}\NormalTok{))}
\NormalTok{\}}

\KeywordTok{rm}\NormalTok{(currentjur_county)}
\end{Highlighting}
\end{Shaded}

\textbf{Note:} Condos that have their own individual addresses are
considered single-family. Once we determine which properties have unique
addresses, the \texttt{category} and \texttt{category\_detail} will be
adjusted to ``SF'' and ``SF attached'' respectively.

\subsubsection{Create categorization
variables}\label{create-categorization-variables}

We use \texttt{ifelse()} and \texttt{case\_when()} to create the three
new variables based on the county land use codes.

\paragraph{}\label{section}

\subparagraph{\texorpdfstring{\texttt{residential}}{residential}}\label{residential}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{res_codes <-}\StringTok{ }
\StringTok{  }\KeywordTok{c}\NormalTok{(}\StringTok{"CONDOMINIUM (RESIDENTIAL)"}\NormalTok{,}
    \StringTok{"DUPLEX"}\NormalTok{,}
    \StringTok{"MOBILE/MANUFACTURED HOMES"}\NormalTok{,}
    \StringTok{"MULTI-FAMILY"}\NormalTok{,}
    \StringTok{"MULTI-FAMILY - VACANT"}\NormalTok{,}
    \StringTok{"MULTIPLE OCCUPANCIES"}\NormalTok{,}
    \StringTok{"RES CONDO GARAGE UNIT"}\NormalTok{,}
    \StringTok{"RESIDENTIAL CONDOS"}\NormalTok{,}
    \StringTok{"RURAL RESIDENCE (AGRICULTURAL)"}\NormalTok{,}
    \StringTok{"RURAL RESIDENCE AGRICULTURAL"}\NormalTok{,}
    \StringTok{"SINGLE FAMILY"}\NormalTok{,}
    \StringTok{"SINGLE FAMILY - VACANT"}\NormalTok{,}
    \StringTok{"TOWN HOUSES"}\NormalTok{,}
    \StringTok{"TOWNHOUSES - VACANT"}\NormalTok{,}
    \StringTok{"TRAILER PARK"}\NormalTok{,}
    \StringTok{"TRAILER PARK - VACANT"}\NormalTok{)}

\NormalTok{jur <-}\StringTok{ }\NormalTok{jur }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{residential =}
           \KeywordTok{ifelse}\NormalTok{(countylandusedescription }\OperatorTok{%in%}\StringTok{ }\NormalTok{res_codes, }\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{))}

\KeywordTok{rm}\NormalTok{(res_codes)}
\end{Highlighting}
\end{Shaded}

\subparagraph{\texorpdfstring{\texttt{category}}{category}}\label{category}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{other <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"AUTO SALES"}\NormalTok{,}
                \StringTok{"AUTOMOTIVE BUILDINGS"}\NormalTok{,}
                \StringTok{"BANK"}\NormalTok{,}
                \StringTok{"CEMETERY"}\NormalTok{,}
                \StringTok{"CHURCH"}\NormalTok{,}
                \StringTok{"COMMERCIAL"}\NormalTok{,}
                \StringTok{"COMMERCIAL CONDO'S"}\NormalTok{,}
                \StringTok{"COMMERCIAL CONDOS"}\NormalTok{,}
                \StringTok{"CONDO-FLEX WAREHOUSE"}\NormalTok{,}
                \StringTok{"CONDO-WAREHOUSE"}\NormalTok{,}
                \StringTok{"DATA CENTER"}\NormalTok{,}
                \StringTok{"EDUCATIONAL"}\NormalTok{,}
                \StringTok{"FARM > 20 ACRES"}\NormalTok{,}
                \StringTok{"FAST FOOD RESTAURANT"}\NormalTok{,}
                \StringTok{"FIRE DEPT"}\NormalTok{,}
                \StringTok{"FLEX WAREHOUSE"}\NormalTok{,}
                \StringTok{"GAS AND GO"}\NormalTok{,}
                \StringTok{"GOVERNMENT PROPERTY"}\NormalTok{,}
                \StringTok{"GOVT PROP"}\NormalTok{,}
                \StringTok{"GROCERY STORE"}\NormalTok{,}
                \StringTok{"HANGER"}\NormalTok{,}
                \StringTok{"HOTEL LUXURY"}\NormalTok{,}
                \StringTok{"IMPROVED, USE NOT SPECIFIED"}\NormalTok{,}
                \StringTok{"LEASEHOLD RIGHTS (MISC)"}\NormalTok{,}
                \StringTok{"LIGHT INDUSTRIAL"}\NormalTok{,}
                \StringTok{"MEDICAL BUILDING"}\NormalTok{,}
                \StringTok{"MEDIUM/HEAVY INDUST"}\NormalTok{,}
                \StringTok{"MINI WAREHOUSE"}\NormalTok{,}
                \StringTok{"MISC COMM STRUCTURE"}\NormalTok{,}
                \StringTok{"MISC COMMERCIAL STRUCTURE"}\NormalTok{,}
                \StringTok{"MISC IMPROVEMENTS"}\NormalTok{,}
                \StringTok{"MISCELLANEOUS (GENERAL)"}\NormalTok{,}
                \StringTok{"MOTEL/HOTEL"}\NormalTok{,}
                \StringTok{"OFFICE BUILDING"}\NormalTok{,}
                \StringTok{"OFFICE/RETAIL"}\NormalTok{,}
                \StringTok{"RECREATIONAL"}\NormalTok{,}
                \StringTok{"RESTAURANT"}\NormalTok{,}
                \StringTok{"RETAIL STORE"}\NormalTok{,}
                \StringTok{"SHOPPING CENTER"}\NormalTok{, }
                \StringTok{"WAREHOUSE"}\NormalTok{,}
                \StringTok{"WINERY"}\NormalTok{)}

\NormalTok{mf <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"DUPLEX"}\NormalTok{,}
        \StringTok{"MULTI-FAMILY"}\NormalTok{,}
        \StringTok{"MULTIPLE OCCUPANCIES"}\NormalTok{,}
        \StringTok{"RESIDENTIAL CONDOS"}\NormalTok{,}
        \StringTok{"CONDOMINIUM (RESIDENTIAL)"}\NormalTok{,}
        \StringTok{"RES CONDO GARAGE UNIT"}\NormalTok{)}

\NormalTok{sf <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"RURAL RESIDENCE (AGRICULTURAL)"}\NormalTok{,}
        \StringTok{"RURAL RESIDENCE AGRICULTURAL"}\NormalTok{,}
        \StringTok{"SINGLE FAMILY"}\NormalTok{,}
        \StringTok{"MOBILE/MANUFACTURED HOMES"}\NormalTok{,}
        \StringTok{"TOWN HOUSES"}\NormalTok{,}
        \StringTok{"TRAILER PARK"}\NormalTok{)}

\NormalTok{vacant <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"AUTOMOTIVE BUILDINGS - VACANT"}\NormalTok{,}
            \StringTok{"COMMERCIAL CONDOS - VACANT"}\NormalTok{,}
            \StringTok{"FLEX WAREHOUSE - VACANT"}\NormalTok{,}
            \StringTok{"GROCERY STORE - VACANT"}\NormalTok{,}
            \StringTok{"MINI WAREHOUSE - VACANT"}\NormalTok{,}
            \StringTok{"MISC COMM STRUCTURE - VACANT"}\NormalTok{,}
            \StringTok{"MISC COMMERCIAL STRUCTURE - VACANT"}\NormalTok{, }
            \StringTok{"MISC IMPROVEMENTS - VACANT"}\NormalTok{,}
            \StringTok{"MULTI-FAMILY - VACANT"}\NormalTok{,}
            \StringTok{"OFFICE BUILDING - VACANT"}\NormalTok{,}
            \StringTok{"RECREATIONAL - VACANT"}\NormalTok{,}
            \StringTok{"RETAIL STORE - VACANT"}\NormalTok{,}
            \StringTok{"SHOPPING CENTER - VACANT"}\NormalTok{,}
            \StringTok{"SINGLE FAMILY - VACANT"}\NormalTok{,}
            \StringTok{"TOWNHOUSES - VACANT"}\NormalTok{,}
            \StringTok{"TRAILER PARK - VACANT"}\NormalTok{,}
            \StringTok{"VACANT LAND"}\NormalTok{,}
            \StringTok{"WAREHOUSE - VACANT"}\NormalTok{,}
            \StringTok{"WINERY - VACANT"}\NormalTok{)}

\NormalTok{jur <-}\StringTok{ }\NormalTok{jur }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{category =} \KeywordTok{case_when}\NormalTok{(}
\NormalTok{           countylandusedescription }\OperatorTok{%in%}\StringTok{ }\NormalTok{other }\OperatorTok{~}\StringTok{ "other"}\NormalTok{,}
\NormalTok{           countylandusedescription }\OperatorTok{%in%}\StringTok{ }\NormalTok{mf }\OperatorTok{~}\StringTok{ "mf"}\NormalTok{,}
\NormalTok{           countylandusedescription }\OperatorTok{%in%}\StringTok{ }\NormalTok{sf }\OperatorTok{~}\StringTok{ "sf"}\NormalTok{,}
\NormalTok{           countylandusedescription }\OperatorTok{%in%}\StringTok{ }\NormalTok{vacant }\OperatorTok{~}\StringTok{ "vacant"}\NormalTok{,}
           \KeywordTok{is.na}\NormalTok{(countylandusedescription) }\OperatorTok{~}\StringTok{ "missing"}\NormalTok{))}

\KeywordTok{rm}\NormalTok{(other, mf, sf, vacant)}
\end{Highlighting}
\end{Shaded}

\subparagraph{\texorpdfstring{\texttt{category\_detail}}{category\_detail}}\label{category_detail}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{apartment <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"MULTI-FAMILY"}\NormalTok{,}
               \StringTok{"MULTIPLE OCCUPANCIES"}\NormalTok{)}

\NormalTok{commercial <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"AUTO SALES"}\NormalTok{,}
                \StringTok{"AUTOMOTIVE BUILDINGS"}\NormalTok{,}
                \StringTok{"BANK"}\NormalTok{,}
                \StringTok{"CEMETERY"}\NormalTok{,}
                \StringTok{"CHURCH"}\NormalTok{,}
                \StringTok{"COMMERCIAL"}\NormalTok{,}
                \StringTok{"COMMERCIAL CONDO'S"}\NormalTok{,}
                \StringTok{"COMMERCIAL CONDOS"}\NormalTok{,}
                \StringTok{"CONDO-FLEX WAREHOUSE"}\NormalTok{,}
                \StringTok{"CONDO-WAREHOUSE"}\NormalTok{,}
                \StringTok{"DATA CENTER"}\NormalTok{,}
                \StringTok{"FARM > 20 ACRES"}\NormalTok{,}
                \StringTok{"FAST FOOD RESTAURANT"}\NormalTok{,}
                \StringTok{"FLEX WAREHOUSE"}\NormalTok{,}
                \StringTok{"GAS AND GO"}\NormalTok{,}
                \StringTok{"GROCERY STORE"}\NormalTok{,}
                \StringTok{"HOTEL LUXURY"}\NormalTok{,}
                \StringTok{"LIGHT INDUSTRIAL"}\NormalTok{,}
                \StringTok{"MEDICAL BUILDING"}\NormalTok{,}
                \StringTok{"MEDIUM/HEAVY INDUST"}\NormalTok{,}
                \StringTok{"MINI WAREHOUSE"}\NormalTok{,}
                \StringTok{"MISC COMM STRUCTURE"}\NormalTok{,}
                \StringTok{"MISC COMMERCIAL STRUCTURE"}\NormalTok{,}
                \StringTok{"MOTEL/HOTEL"}\NormalTok{,}
                \StringTok{"RESTAURANT"}\NormalTok{,}
                \StringTok{"RETAIL STORE"}\NormalTok{,}
                \StringTok{"SHOPPING CENTER"}\NormalTok{, }
                \StringTok{"WAREHOUSE"}\NormalTok{,}
                \StringTok{"WINERY"}\NormalTok{)}

\NormalTok{condo <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"RESIDENTIAL CONDOS"}\NormalTok{,}
           \StringTok{"CONDOMINIUM (RESIDENTIAL)"}\NormalTok{,}
           \StringTok{"RES CONDO GARAGE UNIT"}\NormalTok{)}

\NormalTok{duplex <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"DUPLEX"}\NormalTok{)}

\NormalTok{office <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"OFFICE BUILDING"}\NormalTok{,}
            \StringTok{"OFFICE/RETAIL"}\NormalTok{)}

\NormalTok{mfattached <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"MULTI-FAMILY"}\NormalTok{,}
                \StringTok{"MULTIPLE OCCUPANCIES"}\NormalTok{)}

\NormalTok{sfdetached <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"SINGLE FAMILY"}\NormalTok{,}
                \StringTok{"RURAL RESIDENCE (AGRICULTURAL)"}\NormalTok{,}
                \StringTok{"RURAL RESIDENCE AGRICULTURAL"}\NormalTok{)}

\NormalTok{trailer <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"MOBILE/MANUFACTURED HOMES"}\NormalTok{,}
             \StringTok{"TRAILER PARK"}\NormalTok{)}

\NormalTok{townhouse <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"TOWN HOUSES"}\NormalTok{)}

\NormalTok{educational <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"EDUCATIONAL"}\NormalTok{)}

\NormalTok{firedepartment <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"FIRE DEPT"}\NormalTok{)}

\NormalTok{recreational <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"RECREATIONAL"}\NormalTok{)}

\NormalTok{govt <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"GOVERNMENT PROPERTY"}\NormalTok{,}
          \StringTok{"GOVT PROP"}\NormalTok{)}

\NormalTok{otheruse <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"HANGER"}\NormalTok{,}
              \StringTok{"IMPROVED, USE NOT SPECIFIED"}\NormalTok{,}
              \StringTok{"LEASEHOLD RIGHTS (MISC)"}\NormalTok{,}
              \StringTok{"MISC IMPROVEMENTS"}\NormalTok{,}
              \StringTok{"MISCELLANEOUS (GENERAL)"}\NormalTok{)}

\NormalTok{vacantcom <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"AUTOMOTIVE BUILDINGS - VACANT"}\NormalTok{,}
               \StringTok{"COMMERCIAL CONDOS - VACANT"}\NormalTok{,}
               \StringTok{"FLEX WAREHOUSE - VACANT"}\NormalTok{,}
               \StringTok{"GROCERY STORE - VACANT"}\NormalTok{,}
               \StringTok{"MINI WAREHOUSE - VACANT"}\NormalTok{,}
               \StringTok{"MISC COMM STRUCTURE - VACANT"}\NormalTok{,}
               \StringTok{"MISC COMMERCIAL STRUCTURE - VACANT"}\NormalTok{,}
               \StringTok{"RETAIL STORE - VACANT"}\NormalTok{,}
               \StringTok{"SHOPPING CENTER - VACANT"}\NormalTok{,}
               \StringTok{"WAREHOUSE - VACANT"}\NormalTok{,}
               \StringTok{"WINERY - VACANT"}\NormalTok{)}

\NormalTok{vacantother <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"VACANT LAND"}\NormalTok{,}
                 \StringTok{"MISC IMPROVEMENTS - VACANT"}\NormalTok{,}
                 \StringTok{"RECREATIONAL - VACANT"}\NormalTok{)}

\NormalTok{vacantmf <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"MULTI-FAMILY - VACANT"}\NormalTok{)}

\NormalTok{vacantoffice <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"OFFICE BUILDING - VACANT"}\NormalTok{)}

\NormalTok{vacantsf <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"SINGLE FAMILY - VACANT"}\NormalTok{)}

\NormalTok{vacanttownhouse <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"TOWNHOUSES - VACANT"}\NormalTok{)}

\NormalTok{vacanttrailer <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"TRAILER PARK - VACANT"}\NormalTok{)}

\NormalTok{jur <-}\StringTok{ }\NormalTok{jur }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{category_detail =} \KeywordTok{case_when}\NormalTok{(}
\NormalTok{           countylandusedescription }\OperatorTok{%in%}\StringTok{ }\NormalTok{apartment }\OperatorTok{~}\StringTok{ "apartment"}\NormalTok{,}
\NormalTok{           countylandusedescription }\OperatorTok{%in%}\StringTok{ }\NormalTok{commercial }\OperatorTok{~}\StringTok{ "commercial"}\NormalTok{,}
\NormalTok{           countylandusedescription }\OperatorTok{%in%}\StringTok{ }\NormalTok{condo }\OperatorTok{~}\StringTok{ "condo"}\NormalTok{,}
\NormalTok{           countylandusedescription }\OperatorTok{%in%}\StringTok{ }\NormalTok{duplex }\OperatorTok{~}\StringTok{ "duplex"}\NormalTok{,}
\NormalTok{           countylandusedescription }\OperatorTok{%in%}\StringTok{ }\NormalTok{office }\OperatorTok{~}\StringTok{ "office"}\NormalTok{,}
\NormalTok{           countylandusedescription }\OperatorTok{%in%}\StringTok{ }\NormalTok{mfattached }\OperatorTok{~}\StringTok{ "mf attached"}\NormalTok{,}
\NormalTok{           countylandusedescription }\OperatorTok{%in%}\StringTok{ }\NormalTok{sfdetached }\OperatorTok{~}\StringTok{ "sf detached"}\NormalTok{,}
\NormalTok{           countylandusedescription }\OperatorTok{%in%}\StringTok{ }\NormalTok{trailer }\OperatorTok{~}\StringTok{ "trailer"}\NormalTok{,}
\NormalTok{           countylandusedescription }\OperatorTok{%in%}\StringTok{ }\NormalTok{townhouse }\OperatorTok{~}\StringTok{ "townhouse"}\NormalTok{,}
\NormalTok{           countylandusedescription }\OperatorTok{%in%}\StringTok{ }\NormalTok{educational }\OperatorTok{~}\StringTok{ "educational"}\NormalTok{,}
\NormalTok{           countylandusedescription }\OperatorTok{%in%}\StringTok{ }\NormalTok{firedepartment }\OperatorTok{~}\StringTok{ "fire department"}\NormalTok{,}
\NormalTok{           countylandusedescription }\OperatorTok{%in%}\StringTok{ }\NormalTok{recreational }\OperatorTok{~}\StringTok{ "recreational"}\NormalTok{,}
\NormalTok{           countylandusedescription }\OperatorTok{%in%}\StringTok{ }\NormalTok{govt }\OperatorTok{~}\StringTok{ "government"}\NormalTok{,}
\NormalTok{           countylandusedescription }\OperatorTok{%in%}\StringTok{ }\NormalTok{otheruse }\OperatorTok{~}\StringTok{ "other use"}\NormalTok{,}
\NormalTok{           countylandusedescription }\OperatorTok{%in%}\StringTok{ }\NormalTok{vacantcom }\OperatorTok{~}\StringTok{ "vacant commercial"}\NormalTok{,}
\NormalTok{           countylandusedescription }\OperatorTok{%in%}\StringTok{ }\NormalTok{vacantother }\OperatorTok{~}\StringTok{ "vacant other"}\NormalTok{,}
\NormalTok{           countylandusedescription }\OperatorTok{%in%}\StringTok{ }\NormalTok{vacantmf }\OperatorTok{~}\StringTok{ "vacant mf"}\NormalTok{,}
\NormalTok{           countylandusedescription }\OperatorTok{%in%}\StringTok{ }\NormalTok{vacantoffice }\OperatorTok{~}\StringTok{ "vacant office"}\NormalTok{,}
\NormalTok{           countylandusedescription }\OperatorTok{%in%}\StringTok{ }\NormalTok{vacantsf }\OperatorTok{~}\StringTok{ "vacant sf"}\NormalTok{,}
\NormalTok{           countylandusedescription }\OperatorTok{%in%}\StringTok{ }\NormalTok{vacanttownhouse }\OperatorTok{~}\StringTok{ "vacant townhouse"}\NormalTok{,}
\NormalTok{           countylandusedescription }\OperatorTok{%in%}\StringTok{ }\NormalTok{vacanttrailer }\OperatorTok{~}\StringTok{ "vacant trailer"}\NormalTok{,}
           \KeywordTok{is.na}\NormalTok{(countylandusedescription) }\OperatorTok{~}\StringTok{ "missing"}\NormalTok{))}

\KeywordTok{rm}\NormalTok{(apartment, commercial, condo, duplex,}
\NormalTok{   office, mfattached, sfdetached, trailer, townhouse,}
\NormalTok{   educational, firedepartment, recreational, govt, otheruse, vacantcom, vacantother, vacantmf,}
\NormalTok{   vacantoffice, vacantsf, vacanttownhouse, vacanttrailer)}
\end{Highlighting}
\end{Shaded}

\subparagraph{\texorpdfstring{\texttt{building\_type}}{building\_type}}\label{building_type}

\subparagraph{\texorpdfstring{For Loudoun county, we do not create a
building type variable because this level of specification is not
available in the Black Knight data. However, we leave `building type' as
a blank / existing variable to avoid running into errors later in the
code.}{For Loudoun county, we do not create a building type variable because this level of specification is not available in the Black Knight data. However, we leave building type as a blank / existing variable to avoid running into errors later in the code.}}\label{for-loudoun-county-we-do-not-create-a-building-type-variable-because-this-level-of-specification-is-not-available-in-the-black-knight-data.-however-we-leave-building-type-as-a-blank-existing-variable-to-avoid-running-into-errors-later-in-the-code.}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{jur <-}\StringTok{ }\NormalTok{jur }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{building_type =} \StringTok{""}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\subsubsection{Check variable
classifications}\label{check-variable-classifications}

\subsection{These checks make sure that all county land use codes
recieved new classifications, and shows the distribution of
properties}\label{these-checks-make-sure-that-all-county-land-use-codes-recieved-new-classifications-and-shows-the-distribution-of-properties}

\paragraph{}\label{section-1}

\subparagraph{\texorpdfstring{\texttt{residential}}{residential}}\label{residential-1}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{count}\NormalTok{(jur, residential)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 2 x 2
##   residential      n
##         <dbl>  <int>
## 1           0  18156
## 2           1 118681
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{count}\NormalTok{(jur, }\KeywordTok{is.na}\NormalTok{(residential))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 1 x 2
##   `is.na(residential)`      n
##   <lgl>                 <int>
## 1 FALSE                136837
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{if}\NormalTok{ (}\OtherTok{TRUE} \OperatorTok{%in%}\StringTok{ }\KeywordTok{is.na}\NormalTok{(jur}\OperatorTok{$}\NormalTok{residential)) \{}
  \KeywordTok{warning}\NormalTok{(}\StringTok{"NAs introduced"}\NormalTok{)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\subparagraph{\texorpdfstring{\texttt{category}}{category}}\label{category-1}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{count}\NormalTok{(jur, category)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 5 x 2
##   category      n
##   <chr>     <int>
## 1 mf        15459
## 2 missing       1
## 3 other      5468
## 4 sf       103192
## 5 vacant    12717
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{count}\NormalTok{(jur, }\KeywordTok{is.na}\NormalTok{(category))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 1 x 2
##   `is.na(category)`      n
##   <lgl>              <int>
## 1 FALSE             136837
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{if}\NormalTok{ (}\OtherTok{TRUE} \OperatorTok{%in%}\StringTok{ }\KeywordTok{is.na}\NormalTok{(jur}\OperatorTok{$}\NormalTok{category)) \{}
  \KeywordTok{warning}\NormalTok{(}\StringTok{"NAs introduced"}\NormalTok{)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\subparagraph{\texorpdfstring{\texttt{category\_detail}}{category\_detail}}\label{category_detail-1}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{count}\NormalTok{(jur, category_detail)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 21 x 2
##    category_detail     n
##    <chr>           <int>
##  1 apartment          77
##  2 commercial       4025
##  3 condo           14743
##  4 duplex            639
##  5 educational       194
##  6 fire department    22
##  7 government         39
##  8 missing             1
##  9 office            386
## 10 other use         678
## # ... with 11 more rows
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{count}\NormalTok{(jur, }\KeywordTok{is.na}\NormalTok{(category_detail))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 1 x 2
##   `is.na(category_detail)`      n
##   <lgl>                     <int>
## 1 FALSE                    136837
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{if}\NormalTok{ (}\OtherTok{TRUE} \OperatorTok{%in%}\StringTok{ }\KeywordTok{is.na}\NormalTok{(jur}\OperatorTok{$}\NormalTok{category_detail)) \{}
  \KeywordTok{warning}\NormalTok{(}\StringTok{"NAs introduced"}\NormalTok{)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\subparagraph{\texorpdfstring{\texttt{building\_type}}{building\_type}}\label{building_type-1}

Here, we expect NAs since \texttt{building\_type} is only for MF
properties- but we should have the same number of non-missing values as
we do MF observations

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{newcat <-}\StringTok{ }\KeywordTok{sum}\NormalTok{(}\OperatorTok{!}\KeywordTok{is.na}\NormalTok{(jur}\OperatorTok{$}\NormalTok{building_type))}
\NormalTok{mf <-}\StringTok{ }\KeywordTok{nrow}\NormalTok{(}\KeywordTok{filter}\NormalTok{(jur, category }\OperatorTok{==}\StringTok{ "mf"}\NormalTok{))}

\ControlFlowTok{if}\NormalTok{ (mf }\OperatorTok{!=}\StringTok{ }\NormalTok{newcat) \{}
  \KeywordTok{warning}\NormalTok{(newcat, }\StringTok{" observations categorized, expecting "}\NormalTok{, mf)}
\NormalTok{\}}

\KeywordTok{rm}\NormalTok{(newcat, mf)}
\end{Highlighting}
\end{Shaded}

\subsubsection{Recreate lot size}\label{recreate-lot-size}

There are errors in the different Black Knight lot size variables that
make it impossible to compare lot size when reported in acres and square
feet. Here, we create two new variables, \texttt{lotsize\_acres} and
\texttt{lotsize\_sf} that standardize the unit of measurement. These
variables will also convert values of 0 to \texttt{NA}, which will
simplify calculations down the line.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{count}\NormalTok{(jur, lotsizeareaunit)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 3 x 2
##   lotsizeareaunit     n
##   <chr>           <int>
## 1 AC              22477
## 2 SF              97002
## 3 <NA>            17358
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{jur <-}\StringTok{ }\NormalTok{jur }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{lotsize_acres =} \KeywordTok{case_when}\NormalTok{(lotsizeareaunit }\OperatorTok{==}\StringTok{ "AC"} \OperatorTok{~}\StringTok{ }\NormalTok{lotsizeorarea ,}
\NormalTok{                                   lotsizeareaunit }\OperatorTok{==}\StringTok{ "SF"} \OperatorTok{~}\StringTok{ }\NormalTok{lotsizeorarea }\OperatorTok{/}\StringTok{ }\DecValTok{43560}\NormalTok{),}
         \DataTypeTok{lotsize_sf =}\NormalTok{ lotsize_acres }\OperatorTok{*}\StringTok{ }\DecValTok{43560}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{mutate_at}\NormalTok{(}\KeywordTok{vars}\NormalTok{(lotsize_acres, lotsize_sf), }\OperatorTok{~}\StringTok{ }\KeywordTok{replace}\NormalTok{(., .}\OperatorTok{==}\DecValTok{0}\NormalTok{, }\OtherTok{NA}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\subsection{Collapsing properties}\label{collapsing-properties}

Next, we need to collapse parcels to the number of units per acre,
primarily due to condos having seperate parcel numbers.

\subsubsection{Preserving parcel
numbers}\label{preserving-parcel-numbers}

Parcels that have the same address do not share the same parcel ID, but
they do share the same first five digits. We can clean up the parcel ID
and preserve the first 5 digits in case there is a need to later combine
with another parcel-level dataset.

First- summarize and create a list, so we can see all the cases where
there is not a unique partial parcel number for each address. If there
is more than one 5-digit parcel ID for the building, we replace
\texttt{parcel\_address} with \texttt{NA}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{jur <-}\StringTok{ }\NormalTok{jur }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{parcel_address =} \KeywordTok{substr}\NormalTok{(assessorsparcelnumberapnpin, }\DecValTok{1}\NormalTok{, }\DecValTok{6}\NormalTok{)) }

\NormalTok{bad_parcels <-}\StringTok{ }\NormalTok{jur }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{group_by}\NormalTok{(propaddress) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{summarize}\NormalTok{(}\DataTypeTok{parcel =} \KeywordTok{list}\NormalTok{(parcel_address)) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{unq_parcels =} \KeywordTok{as.integer}\NormalTok{(}\KeywordTok{map}\NormalTok{(parcel, }
                                  \ControlFlowTok{function}\NormalTok{(x) }\KeywordTok{length}\NormalTok{(}\KeywordTok{unique}\NormalTok{(x))))) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(unq_parcels }\OperatorTok{>}\StringTok{ }\DecValTok{1}\NormalTok{)}

\NormalTok{bad_addresses <-}\StringTok{ }\NormalTok{bad_parcels }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{pull}\NormalTok{(propaddress)}

\NormalTok{jur <-}\StringTok{ }\NormalTok{jur }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{parcel_address =} \KeywordTok{ifelse}\NormalTok{(propaddress }\OperatorTok{%in%}\StringTok{ }\NormalTok{bad_addresses,}
                                 \OtherTok{NA}\NormalTok{,}
\NormalTok{                                 parcel_address))}

\KeywordTok{rm}\NormalTok{(bad_addresses, bad_parcels)}
\end{Highlighting}
\end{Shaded}

We can do a quick check to make sure that there are no properties that
have the same address but different parcel IDs by seeing if the number
of rows are the same when we group by address and parcel ID, vs.~just
grouping by address.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x <-}\StringTok{ }\NormalTok{jur }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(residential }\OperatorTok{==}\StringTok{ }\DecValTok{1}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{group_by}\NormalTok{(propaddress) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{count}\NormalTok{() }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{nrow}\NormalTok{()}

\NormalTok{y <-}\StringTok{ }\NormalTok{jur }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(residential }\OperatorTok{==}\StringTok{ }\DecValTok{1}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{group_by}\NormalTok{(propaddress, parcel_address) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{count}\NormalTok{() }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{nrow}\NormalTok{()}

\ControlFlowTok{if}\NormalTok{ (x }\OperatorTok{==}\StringTok{ }\NormalTok{y) \{}
  \KeywordTok{print}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(x, }\StringTok{" = "}\NormalTok{, y, }\StringTok{": clean collapse"}\NormalTok{))}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (y }\OperatorTok{>}\StringTok{ }\NormalTok{x) \{}
    \KeywordTok{warning}\NormalTok{(}\StringTok{"additional observations introduced"}\NormalTok{)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "112238 = 112238: clean collapse"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{rm}\NormalTok{(x, y)}
\end{Highlighting}
\end{Shaded}

\subsubsection{House number cleaning}\label{house-number-cleaning}

There are a number of properties that have numbers or symbols in their
house numbers that prevent a collapse. This next step removes those
characters so the collapse is clean. This will also recategorize
properties that have a missing house number as properties that have a
missing address. This is important for the collapse because it could
cause us to combine two observations that would otherwise be seperate.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{jur <-}\StringTok{ }\NormalTok{jur }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{house_letter =} \KeywordTok{ifelse}\NormalTok{(}\KeywordTok{str_detect}\NormalTok{(prophouseno, }\StringTok{"[:alpha:]"}\NormalTok{) }\OperatorTok{==}\StringTok{ }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{),}
         \DataTypeTok{oldadd =}\NormalTok{ propaddress,}
         \DataTypeTok{new_houseno =} \KeywordTok{ifelse}\NormalTok{(house_letter }\OperatorTok{==}\StringTok{ }\DecValTok{1}\NormalTok{,}
                              \KeywordTok{str_replace}\NormalTok{(prophouseno, }\StringTok{"[:alpha:]"}\NormalTok{, }\StringTok{""}\NormalTok{), }
\NormalTok{                              prophouseno),}
         \DataTypeTok{propaddress =} \KeywordTok{ifelse}\NormalTok{(house_letter }\OperatorTok{==}\StringTok{ }\DecValTok{1}\NormalTok{, }
                              \KeywordTok{paste}\NormalTok{(}\KeywordTok{str_replace_all}\NormalTok{(new_houseno, }\StringTok{"-"}\NormalTok{, }\StringTok{""}\NormalTok{),}
\NormalTok{                                    propstreetname, }
\NormalTok{                                    propstreetsuffix,}
                                    \DataTypeTok{sep =} \StringTok{" "}\NormalTok{),}
\NormalTok{                              propaddress))}
\end{Highlighting}
\end{Shaded}

Compare the first 20 addresses to check

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{jur }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(house_letter }\OperatorTok{==}\StringTok{ }\DecValTok{1}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{select}\NormalTok{(oldadd, propaddress, category_detail) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{head}\NormalTok{(}\DecValTok{20}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 20 x 3
##    oldadd           propaddress     category_detail
##    <chr>            <chr>           <chr>          
##  1 1024A BRIXTON CT 1024 BRIXTON CT condo          
##  2 1024C BRIXTON CT 1024 BRIXTON CT condo          
##  3 1026A BRIXTON CT 1026 BRIXTON CT condo          
##  4 1026C BRIXTON CT 1026 BRIXTON CT condo          
##  5 1028A BRIXTON CT 1028 BRIXTON CT condo          
##  6 1028C BRIXTON CT 1028 BRIXTON CT condo          
##  7 1030A BRIXTON CT 1030 BRIXTON CT condo          
##  8 1030C BRIXTON CT 1030 BRIXTON CT condo          
##  9 1032A BRIXTON CT 1032 BRIXTON CT condo          
## 10 1032C BRIXTON CT 1032 BRIXTON CT condo          
## 11 1034A BRIXTON CT 1034 BRIXTON CT condo          
## 12 1034C BRIXTON CT 1034 BRIXTON CT condo          
## 13 1036A BRIXTON CT 1036 BRIXTON CT condo          
## 14 1036C BRIXTON CT 1036 BRIXTON CT condo          
## 15 1037A BRIXTON CT 1037 BRIXTON CT condo          
## 16 1037C BRIXTON CT 1037 BRIXTON CT condo          
## 17 1038A BRIXTON CT 1038 BRIXTON CT condo          
## 18 1038C BRIXTON CT 1038 BRIXTON CT condo          
## 19 1039A BRIXTON CT 1039 BRIXTON CT condo          
## 20 1039C BRIXTON CT 1039 BRIXTON CT condo
\end{verbatim}

After this change, the number of NAs in the address variable should be
the same as the number of observations that previously had either a
missing address, missing house number, or both.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{stopifnot}\NormalTok{(}\KeywordTok{sum}\NormalTok{(}\KeywordTok{is.na}\NormalTok{(jur}\OperatorTok{$}\NormalTok{propaddress)) }\OperatorTok{==}\StringTok{ }\KeywordTok{nrow}\NormalTok{(}\KeywordTok{filter}\NormalTok{(jur, }
            \KeywordTok{is.na}\NormalTok{(propaddress) }\OperatorTok{|}\StringTok{ }\KeywordTok{is.na}\NormalTok{(prophouseno))))}
\end{Highlighting}
\end{Shaded}

\subsubsection{Address break out}\label{address-break-out}

In order to do the collapse, we first identify addresses with more than
one observation, and filter out those with a missing house number or
address to avoid an improper collapse. Then, run a quick check to make
sure there are no NAs.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{jur <-}\StringTok{ }\NormalTok{jur }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{classify_addresses}\NormalTok{()}

\KeywordTok{count}\NormalTok{(jur, address_type)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 3 x 2
##   address_type      n
##   <chr>         <int>
## 1 missing       10844
## 2 multiple       9185
## 3 single       116808
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{if}\NormalTok{ (}\OtherTok{TRUE} \OperatorTok{%in%}\StringTok{ }\KeywordTok{is.na}\NormalTok{(jur}\OperatorTok{$}\NormalTok{address_type)) \{}
  \KeywordTok{warning}\NormalTok{(}\StringTok{"NAs in address_type"}\NormalTok{)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

For townhouses and other forms of attached housing, we do not want a
collapse, since this is a function of addressing and not the unit type.
We will reclassify the address type as \texttt{single} for properties
that have a value of \texttt{sf\ attached} and \texttt{townhouse} for
the \texttt{category\_detail} variable.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{jur <-}\StringTok{ }\NormalTok{jur }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{address_type =} \KeywordTok{ifelse}\NormalTok{(category_detail }\OperatorTok{%in%}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"townhouse"}\NormalTok{, }\StringTok{"sf attached"}\NormalTok{),}
                                  \StringTok{"single"}\NormalTok{,}
\NormalTok{                                  address_type))}
\end{Highlighting}
\end{Shaded}

Seperate the address types for different operations.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{multiples <-}\StringTok{ }\NormalTok{jur }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(address_type }\OperatorTok{==}\StringTok{ "multiple"}\NormalTok{)}

\NormalTok{singles <-}\StringTok{ }\NormalTok{jur }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(address_type }\OperatorTok{==}\StringTok{ "single"}\NormalTok{)}

\NormalTok{missing <-}\StringTok{ }\NormalTok{jur }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(address_type }\OperatorTok{==}\StringTok{ "missing"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

For addresses that have some records with missing zoning, but others
that have a zoning designation: we need to fill the NAs with the
appropriate zoning code. \texttt{group\_by()} means that zoning codes
will not be passed on to observations with a different address, and
using \texttt{fill()} in both directions means that the NAs will be
filled regardless of their position.

\subsubsection{Multiple addresses}\label{multiple-addresses}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{multiples <-}\StringTok{ }\NormalTok{multiples }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{group_by}\NormalTok{(propaddress) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{fill}\NormalTok{(zoning) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{fill}\NormalTok{(zoning, }\DataTypeTok{.direction =} \StringTok{"up"}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{ungroup}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

Next, we summarize the data using nested lists, which allow us to
preserve all the details from each record and apply the right function
to each. The table below describes each variable, which function to use,
and what to do in the case of a tie. Lot size is a unique case, detail
provided in the next section.

\begin{longtable}[]{@{}lll@{}}
\toprule
variable & operation & in case of tie\tabularnewline
\midrule
\endhead
zoning & mode & take most dense zoning code (?)\tabularnewline
lotsize\_sf & conditional based on values &\tabularnewline
buildingarea & sum &\tabularnewline
countylandusedescription & mode & case-by-case basis\tabularnewline
residential & max & residential\tabularnewline
category & mode & case-by-case basis\tabularnewline
category\_detail & mode & case-by-case basis\tabularnewline
building\_type & mode & case-by-case basis\tabularnewline
yearbuilt & max & take maxiumum year- accounts for
renovation\tabularnewline
long & median & median longitude and latitude ensures this is a correct
pairing, falls within the address\tabularnewline
lat & median & median longitude and latitude ensures this is a correct
pairing, falls within the address\tabularnewline
\bottomrule
\end{longtable}

\textbf{Note:} there are some instances where there are no
non-\texttt{NA} values, so this next step will throw some warning
messages.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nested <-}\StringTok{ }\NormalTok{multiples }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{group_by}\NormalTok{(propaddress, parcel_address) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{summarize_at}\NormalTok{(}\KeywordTok{vars}\NormalTok{(zoning, lotsize_sf,}
\NormalTok{                    buildingarea, countylandusedescription,}
\NormalTok{                    residential, category, category_detail, building_type,}
\NormalTok{                    yearbuilt, long, lat), list) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{rename_at}\NormalTok{(}\KeywordTok{vars}\NormalTok{(}\OperatorTok{-}\NormalTok{propaddress, }\OperatorTok{-}\NormalTok{parcel_address), }\OperatorTok{~}\StringTok{ }\KeywordTok{paste0}\NormalTok{(., }\StringTok{"_list"}\NormalTok{)) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{nprops =} \KeywordTok{map}\NormalTok{(zoning_list, length),}
         \DataTypeTok{zoning =} \KeywordTok{map}\NormalTok{(zoning_list, Mode),}
         \DataTypeTok{lotsize_sf_sum =} \KeywordTok{map_dbl}\NormalTok{(lotsize_sf_list, sum, }\DataTypeTok{na.rm =} \OtherTok{TRUE}\NormalTok{),}
         \DataTypeTok{buildingarea =} \KeywordTok{map_dbl}\NormalTok{(buildingarea_list, sum, }\DataTypeTok{na.rm =} \OtherTok{TRUE}\NormalTok{),}
         \DataTypeTok{countylandusedescription =} \KeywordTok{map}\NormalTok{(countylandusedescription_list, Mode),}
         \DataTypeTok{residential =} \KeywordTok{map}\NormalTok{(residential_list, max, }\DataTypeTok{na.rm =} \OtherTok{FALSE}\NormalTok{),}
         \DataTypeTok{category =} \KeywordTok{map}\NormalTok{(category_list, Mode),}
         \DataTypeTok{category_detail =} \KeywordTok{map}\NormalTok{(category_detail_list, Mode),}
         \DataTypeTok{building_type =} \KeywordTok{ifelse}\NormalTok{(category }\OperatorTok{==}\StringTok{ "MF"}\NormalTok{,}
                                \KeywordTok{map}\NormalTok{(building_type_list, Mode),}
                                \OtherTok{NA}\NormalTok{),}
         \DataTypeTok{long =} \KeywordTok{map}\NormalTok{(long_list, median),}
         \DataTypeTok{lat =} \KeywordTok{map}\NormalTok{(lat_list, median),}
         \CommentTok{# year built handled differently due to missing values}
         \DataTypeTok{yearbuilt_list =} \KeywordTok{ifelse}\NormalTok{(}\KeywordTok{as.integer}\NormalTok{(}\KeywordTok{map}\NormalTok{(yearbuilt_list, }\ControlFlowTok{function}\NormalTok{(x) }\KeywordTok{sum}\NormalTok{(}\OperatorTok{!}\KeywordTok{is.na}\NormalTok{(x)))) }\OperatorTok{==}\StringTok{ }\DecValTok{0}\NormalTok{,}
                                 \OtherTok{NA}\NormalTok{,}
\NormalTok{                                 yearbuilt_list),}
         \DataTypeTok{yearbuilt =} \KeywordTok{ifelse}\NormalTok{(}\OperatorTok{!}\KeywordTok{is.na}\NormalTok{(yearbuilt_list),}
                      \KeywordTok{map}\NormalTok{(yearbuilt_list, max, }\DataTypeTok{na.rm =} \OtherTok{TRUE}\NormalTok{),}
                      \OtherTok{NA}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\paragraph{Lot size}\label{lot-size}

Lot size cannot be summarized with one operation, because it is reported
differently for different buildings. The following examples show five
cases that we have to reconcile.

\begin{itemize}
\tightlist
\item
  In the first instance, the lot size is repeated- the number of unique
  lot sizes is 1, so mode is the right function.
\item
  In the second instance, the sum of the lot size is the incorrect lot
  size, and the mode is a better function- but there is more than one
  unique value.
\item
  In the third example, the mode would give is a lot size of 0, which is
  also incorrect- but again, every value is not unique.
\item
  In the fourth instance, there are the same number of unique values as
  there are properties- sum is the correct function.
\item
  In the fifth instance, we need to replace the lot size of 0 with
  \texttt{NA}, so future operations will also return \texttt{NA}.
\end{itemize}

First, filter out all the observations where the function is known.
Then, re-examine the remaining observations. There are a few variables
needed: 1. The number of unique observations in the
\texttt{lotsize\_sf\_list} nested list 2. The sum, Mode (if unique), and
first observation (in the case of a tie in the mode)

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nested <-}\StringTok{ }\NormalTok{nested }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{nprops =} \KeywordTok{as.integer}\NormalTok{(nprops),}
         \DataTypeTok{lotsiz_sf_sum =} \KeywordTok{as.integer}\NormalTok{(lotsize_sf_sum),}
         \DataTypeTok{unique_lots =} \KeywordTok{map}\NormalTok{(lotsize_sf_list, }\ControlFlowTok{function}\NormalTok{(x) }\KeywordTok{length}\NormalTok{(}\KeywordTok{unique}\NormalTok{(x))),}
         \DataTypeTok{lsfirst =} \KeywordTok{map}\NormalTok{(lotsize_sf_list, }\ControlFlowTok{function}\NormalTok{(x) x[}\DecValTok{1}\NormalTok{]),}
         \DataTypeTok{lsmode =} \KeywordTok{ifelse}\NormalTok{(lotsize_sf_sum }\OperatorTok{==}\StringTok{ }\DecValTok{0}\NormalTok{,}
                         \OtherTok{NA}\NormalTok{,}
                         \KeywordTok{map}\NormalTok{(lotsize_sf_list, Mode, }\DataTypeTok{na.rm =} \OtherTok{TRUE}\NormalTok{))}
\NormalTok{         ) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{ungroup}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

Based on these variables, we can identify when\texttt{sum()} is
definitely the right function (when the number of unique values in
\texttt{lotsize\_sf\_list} is the same as \texttt{nprops}), and when we
want to take the first argument is definitely the right function (there
is only one unique value in \texttt{lotsize\_sf\_list}).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nested <-}\StringTok{ }\NormalTok{nested }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{fxn =} \KeywordTok{case_when}\NormalTok{(}
\NormalTok{    lotsize_sf_sum }\OperatorTok{<}\StringTok{ }\DecValTok{1} \OperatorTok{~}\StringTok{ "missing"}\NormalTok{,}
\NormalTok{    nprops }\OperatorTok{==}\StringTok{ }\NormalTok{unique_lots }\OperatorTok{~}\StringTok{ "sum"}\NormalTok{,}
\NormalTok{    unique_lots }\OperatorTok{==}\StringTok{ }\DecValTok{1} \OperatorTok{~}\StringTok{ "first"}\NormalTok{,}
    \OtherTok{TRUE} \OperatorTok{~}\StringTok{ "other"}
\NormalTok{  ))}

\NormalTok{nested }\OperatorTok{%>%}\StringTok{ }\KeywordTok{count}\NormalTok{(fxn)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 4 x 2
##   fxn         n
##   <chr>   <int>
## 1 first      25
## 2 missing   765
## 3 other       9
## 4 sum       114
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nested_done <-}\StringTok{ }\NormalTok{nested }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(fxn }\OperatorTok{!=}\StringTok{ "other"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Based on examining the 9 addressess with different criteria, we develop
these assumptions: 1. Properties with more than 500 units are majority
missing, and should be marked missing. 2. If the mode is \textgreater{}
8,000 SF, we will use the mode. 3. For all others, we use the sum.

First, we coerce the \texttt{lsmode} variable into numeric, and then
apply this logic. Then, we remerge with all the multiple addressess and
apply the correct operations.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nested_other <-}\StringTok{ }\NormalTok{nested }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(fxn }\OperatorTok{==}\StringTok{ "other"}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{lsmode_num =} \KeywordTok{ifelse}\NormalTok{(}\KeywordTok{map}\NormalTok{(lsmode, length) }\OperatorTok{>}\StringTok{ }\DecValTok{1}\NormalTok{, }\OtherTok{NA}\NormalTok{, lsmode),}
         \DataTypeTok{lsmode_num =} \KeywordTok{as.integer}\NormalTok{(lsmode_num),}
         \DataTypeTok{fxn =} \KeywordTok{case_when}\NormalTok{(}
\NormalTok{            nprops }\OperatorTok{>}\StringTok{ }\DecValTok{500} \OperatorTok{~}\StringTok{ "missing"}\NormalTok{,}
\NormalTok{            lsmode_num }\OperatorTok{>}\StringTok{ }\DecValTok{8000} \OperatorTok{~}\StringTok{ "mode"}\NormalTok{,}
            \OtherTok{TRUE} \OperatorTok{~}\StringTok{ "sum"}
\NormalTok{  ))}

\KeywordTok{count}\NormalTok{(nested_other, fxn)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 2 x 2
##   fxn       n
##   <chr> <int>
## 1 mode      8
## 2 sum       1
\end{verbatim}

Last, we standardize the variables, recombine the two parts, and select
the appropriate variable for lot side.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nested_all <-}\StringTok{ }\KeywordTok{bind_rows}\NormalTok{(nested_done, nested_other) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{mutate_at}\NormalTok{(}\KeywordTok{vars}\NormalTok{(lotsize_sf_sum, lsfirst, lsmode_num), as.double) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{lotsize_sf_final =} 
           \KeywordTok{case_when}\NormalTok{(fxn }\OperatorTok{==}\StringTok{ "first"} \OperatorTok{~}\StringTok{ }\NormalTok{lsfirst,}
\NormalTok{                     fxn }\OperatorTok{==}\StringTok{ "sum"} \OperatorTok{~}\StringTok{ }\NormalTok{lotsize_sf_sum,}
\NormalTok{                     fxn }\OperatorTok{==}\StringTok{ "other"} \OperatorTok{~}\StringTok{ }\NormalTok{lotsize_sf_sum,}
\NormalTok{                     fxn }\OperatorTok{==}\StringTok{ "mode"} \OperatorTok{~}\StringTok{ }\NormalTok{lsmode_num))}
\end{Highlighting}
\end{Shaded}

The number of NAs should be the same as the number of those with the
designation ``missing''

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{count}\NormalTok{(nested_all, fxn }\OperatorTok{==}\StringTok{ "missing"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 2 x 2
##   `fxn == "missing"`     n
##   <lgl>              <int>
## 1 FALSE                148
## 2 TRUE                 765
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{count}\NormalTok{(nested_all, }\KeywordTok{is.na}\NormalTok{(lotsize_sf_final))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 2 x 2
##   `is.na(lotsize_sf_final)`     n
##   <lgl>                     <int>
## 1 FALSE                       148
## 2 TRUE                        765
\end{verbatim}

Lastly, the number of rows should be the same as before we split and
re-combined.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{stopifnot}\NormalTok{(}\KeywordTok{nrow}\NormalTok{(nested_all) }\OperatorTok{==}\StringTok{ }\KeywordTok{nrow}\NormalTok{(nested))}

\KeywordTok{rm}\NormalTok{(nested, nested_done, nested_other)}
\end{Highlighting}
\end{Shaded}

\paragraph{Ties}\label{ties}

\subparagraph{Zoning}\label{zoning}

There are 21 instances where there is a tie in the zoning code- examples
below.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ties <-}\StringTok{ }\NormalTok{nested_all }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{ties_z =} \KeywordTok{ifelse}\NormalTok{(}\KeywordTok{map}\NormalTok{(zoning, length) }\OperatorTok{>}\StringTok{ }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{)) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(ties_z }\OperatorTok{==}\StringTok{ }\DecValTok{1}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{z1 =} \KeywordTok{map}\NormalTok{(zoning, }\DecValTok{1}\NormalTok{),}
         \DataTypeTok{z2 =} \KeywordTok{map}\NormalTok{(zoning, }\DecValTok{2}\NormalTok{),}
         \DataTypeTok{z3 =} \KeywordTok{map}\NormalTok{(zoning, }\DecValTok{3}\NormalTok{),}
         \DataTypeTok{cl1 =} \KeywordTok{map}\NormalTok{(countylandusedescription, }\DecValTok{1}\NormalTok{),}
         \DataTypeTok{cl2 =} \KeywordTok{map}\NormalTok{(countylandusedescription, }\DecValTok{2}\NormalTok{),}
         \DataTypeTok{cl3 =} \KeywordTok{map}\NormalTok{(countylandusedescription, }\DecValTok{3}\NormalTok{)) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{select}\NormalTok{(propaddress, nprops,}
\NormalTok{         z1, z2, z3,}
\NormalTok{         cl1, cl2, cl3) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{mutate_all}\NormalTok{(as.character)}

\NormalTok{ties }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{select}\NormalTok{(propaddress, z1, z2) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{head}\NormalTok{(}\DecValTok{5}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 5 x 3
##   propaddress              z1    z2   
##   <chr>                    <chr> <chr>
## 1 125 WRIGHTWOOD PL        CR2   PDH3 
## 2 131 S 9TH ST             PV:MC PV:R2
## 3 14 QUARTER BRANCH RD     LV:R1 LV:R2
## 4 1501 EDWARDS FERRY RD NE LB:B3 LB:I1
## 5 15747 TRONGATE CT        AR1   R16
\end{verbatim}

Since there is no definitive way to break these ties, we replace the
\texttt{zoning} variable with \texttt{NA}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nested_all <-}\StringTok{ }\NormalTok{nested_all }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{ties_z =} \KeywordTok{ifelse}\NormalTok{(}\KeywordTok{map}\NormalTok{(zoning, length) }\OperatorTok{>}\StringTok{ }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{)) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{zoning =} \KeywordTok{ifelse}\NormalTok{(ties_z }\OperatorTok{==}\StringTok{ }\DecValTok{1}\NormalTok{,}
                         \OtherTok{NA}\NormalTok{,}
\NormalTok{                         zoning),}
         \DataTypeTok{countylandusedescription =} \KeywordTok{ifelse}\NormalTok{(ties_z }\OperatorTok{==}\StringTok{ }\DecValTok{1}\NormalTok{,}
                                           \OtherTok{NA}\NormalTok{,}
\NormalTok{                                           countylandusedescription)) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{select}\NormalTok{(}\OperatorTok{-}\NormalTok{ties_z)}
\end{Highlighting}
\end{Shaded}

\subparagraph{Category\_detail}\label{category_detail-2}

Ties must also be resolved in several of the other variables. Looking at
the most detailed of these variables (\texttt{category\_detail}) will
allow us to resolve multiple of these ties at once.

First- identify the instances, and see which categories are most common.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cdties <-}\StringTok{ }\NormalTok{nested_all }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(}\KeywordTok{map}\NormalTok{(category_detail, length) }\OperatorTok{>}\StringTok{ }\DecValTok{1}\NormalTok{)}

\NormalTok{cdties }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{category_detail_chr =} \KeywordTok{as.character}\NormalTok{(category_detail)) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{group_by}\NormalTok{(category_detail_chr) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{count}\NormalTok{() }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{arrange}\NormalTok{(}\KeywordTok{desc}\NormalTok{(n))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 13 x 2
## # Groups:   category_detail_chr [13]
##    category_detail_chr                         n
##    <chr>                                   <int>
##  1 "c(\"sf detached\", \"vacant other\")"     63
##  2 "c(\"condo\", \"vacant other\")"           19
##  3 "c(\"commercial\", \"vacant other\")"       5
##  4 "c(\"office\", \"vacant other\")"           3
##  5 "c(\"other use\", \"sf detached\")"         3
##  6 "c(\"commercial\", \"office\")"             2
##  7 "c(\"commercial\", \"sf detached\")"        2
##  8 "c(\"condo\", \"sf detached\")"             2
##  9 "c(\"other use\", \"vacant other\")"        2
## 10 "c(\"apartment\", \"vacant other\")"        1
## 11 "c(\"commercial\", \"condo\")"              1
## 12 "c(\"office\", \"sf detached\")"            1
## 13 "c(\"recreational\", \"vacant other\")"     1
\end{verbatim}

Here, we create a variable to indicate how many of the values in
\texttt{category\_detail} are one of the vacant designations.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cdties <-}\StringTok{ }\NormalTok{cdties }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{test_vacant =} \KeywordTok{as.integer}\NormalTok{(}\KeywordTok{map}\NormalTok{(category_detail, }
                                      \OperatorTok{~}\StringTok{ }\KeywordTok{sum}\NormalTok{(}\KeywordTok{str_detect}\NormalTok{(., }\StringTok{"vacant"}\NormalTok{)))))}

\KeywordTok{count}\NormalTok{(cdties, test_vacant) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{rename}\NormalTok{(}\StringTok{`}\DataTypeTok{Number of vacant categories}\StringTok{`}\NormalTok{ =}\StringTok{ }\NormalTok{test_vacant,}
         \StringTok{`}\DataTypeTok{Number of instances}\StringTok{`}\NormalTok{ =}\StringTok{ }\NormalTok{n) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\StringTok{`}\DataTypeTok{What to do?}\StringTok{`}\NormalTok{ =}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Take the residential code"}\NormalTok{,}
                           \StringTok{"Take the non-vacant categoty"}\NormalTok{)) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\NormalTok{knitr}\OperatorTok{::}\KeywordTok{kable}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}rrl@{}}
\toprule
Number of vacant categories & Number of instances & What to
do?\tabularnewline
\midrule
\endhead
0 & 11 & Take the residential code\tabularnewline
1 & 94 & Take the non-vacant categoty\tabularnewline
\bottomrule
\end{longtable}

We will separate and then recombine to perform different operations and
look at the individual cases for each instance. For all instances- we
will determine position using the entire listed variable (for example,
\texttt{category\_detail\_list}), NOT the variable that displays the tie
(\texttt{category\_detail}). Although they look the same, using the
variable that ends with \texttt{\_list} ensures that all the arguements
are in the same order for all the variables we need to reclassify.

\textbf{If no properties are vacant:} - If one of the values is
residential -\textgreater{} residential - If the tie is between
commercial or office -\textgreater{} first value

We use the residential indicator to determine which argument of the
vector contains the residential category, and then select the same
values by argument position for each other variable that conflicts.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{novac <-}\StringTok{ }\NormalTok{cdties }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(test_vacant }\OperatorTok{==}\StringTok{ }\DecValTok{0}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{test_res1 =} \KeywordTok{map}\NormalTok{(residential_list, }\DecValTok{1}\NormalTok{),}
         \DataTypeTok{test_res2 =} \KeywordTok{map}\NormalTok{(residential_list, }\DecValTok{2}\NormalTok{)) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{argnum =} \KeywordTok{case_when}\NormalTok{(test_res1 }\OperatorTok{==}\StringTok{ }\DecValTok{1} \OperatorTok{~}\StringTok{ }\DecValTok{1}\NormalTok{,}
\NormalTok{                            test_res2 }\OperatorTok{==}\StringTok{ }\DecValTok{1} \OperatorTok{~}\StringTok{ }\DecValTok{2}\NormalTok{,}
                            \OtherTok{TRUE} \OperatorTok{~}\StringTok{ }\DecValTok{1}\NormalTok{)) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{category =} \KeywordTok{ifelse}\NormalTok{(argnum }\OperatorTok{==}\StringTok{ }\DecValTok{1}\NormalTok{,}
                           \KeywordTok{map}\NormalTok{(category_list, }\DecValTok{1}\NormalTok{),}
                           \KeywordTok{map}\NormalTok{(category_list, }\DecValTok{2}\NormalTok{)),}
         \DataTypeTok{category_detail =} \KeywordTok{ifelse}\NormalTok{(argnum }\OperatorTok{==}\StringTok{ }\DecValTok{1}\NormalTok{,}
                           \KeywordTok{map}\NormalTok{(category_detail_list, }\DecValTok{1}\NormalTok{),}
                           \KeywordTok{map}\NormalTok{(category_detail_list, }\DecValTok{2}\NormalTok{)),}
         \DataTypeTok{building_type =} \KeywordTok{ifelse}\NormalTok{(argnum }\OperatorTok{==}\StringTok{ }\DecValTok{1}\NormalTok{,}
                           \KeywordTok{map}\NormalTok{(building_type_list, }\DecValTok{1}\NormalTok{),}
                           \KeywordTok{map}\NormalTok{(building_type_list, }\DecValTok{2}\NormalTok{)),}
         \DataTypeTok{countylandusedescription =} \KeywordTok{ifelse}\NormalTok{(argnum }\OperatorTok{==}\StringTok{ }\DecValTok{1}\NormalTok{,}
                           \KeywordTok{map}\NormalTok{(countylandusedescription_list, }\DecValTok{1}\NormalTok{),}
                           \KeywordTok{map}\NormalTok{(countylandusedescription_list, }\DecValTok{2}\NormalTok{))) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{select}\NormalTok{(}\OperatorTok{-}\NormalTok{test_res1, }\OperatorTok{-}\NormalTok{test_res2, }\OperatorTok{-}\NormalTok{argnum)}
\end{Highlighting}
\end{Shaded}

\textbf{If one value is vacant:} - We want to select the non-vacant
observation. We can test which argument is vacant using
\texttt{str\_detect} and then select the other value.

Since one of these is vacant, we also want to adjust the \texttt{nprops}
variable- which will become our measure of determining number of units
once we bind the multiple addresses back to the single addresses- back
to \texttt{1}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{onevac <-}\StringTok{ }\NormalTok{cdties }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(test_vacant }\OperatorTok{==}\StringTok{ }\DecValTok{1}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{vac1 =} \KeywordTok{str_detect}\NormalTok{(}\KeywordTok{map}\NormalTok{(category_detail_list, }\DecValTok{1}\NormalTok{), }\StringTok{"vacant"}\NormalTok{)) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{category =} \KeywordTok{ifelse}\NormalTok{(vac1 }\OperatorTok{==}\StringTok{ }\OtherTok{FALSE}\NormalTok{,}
                           \KeywordTok{map}\NormalTok{(category_list, }\DecValTok{1}\NormalTok{),}
                           \KeywordTok{map}\NormalTok{(category_list, }\DecValTok{2}\NormalTok{)),}
         \DataTypeTok{category_detail =} \KeywordTok{ifelse}\NormalTok{(vac1 }\OperatorTok{==}\StringTok{ }\OtherTok{FALSE}\NormalTok{,}
                           \KeywordTok{map}\NormalTok{(category_detail_list, }\DecValTok{1}\NormalTok{),}
                           \KeywordTok{map}\NormalTok{(category_detail_list, }\DecValTok{2}\NormalTok{)),}
         \DataTypeTok{building_type =} \KeywordTok{ifelse}\NormalTok{(vac1 }\OperatorTok{==}\StringTok{ }\OtherTok{FALSE}\NormalTok{,}
                           \KeywordTok{map}\NormalTok{(building_type_list, }\DecValTok{1}\NormalTok{),}
                           \KeywordTok{map}\NormalTok{(building_type_list, }\DecValTok{2}\NormalTok{)),}
         \DataTypeTok{countylandusedescription =} \KeywordTok{ifelse}\NormalTok{(vac1 }\OperatorTok{==}\StringTok{ }\OtherTok{FALSE}\NormalTok{,}
                           \KeywordTok{map}\NormalTok{(countylandusedescription_list, }\DecValTok{1}\NormalTok{),}
                           \KeywordTok{map}\NormalTok{(countylandusedescription_list, }\DecValTok{2}\NormalTok{))) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{nprops =} \DecValTok{1}\NormalTok{,}
         \DataTypeTok{vacant_flag =} \DecValTok{1}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{select}\NormalTok{(}\OperatorTok{-}\NormalTok{vac1)}

\CommentTok{# this value will be used later to check the number of rows}
\NormalTok{nunits <-}\StringTok{ }\NormalTok{cdties }\OperatorTok{%>%}\StringTok{ }\KeywordTok{filter}\NormalTok{(test_vacant }\OperatorTok{==}\StringTok{ }\DecValTok{1}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{summarize}\NormalTok{(}\KeywordTok{sum}\NormalTok{(nprops)) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{pull}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\textbf{If both values are vacant:} There are few examples of this, but
in each case we want to default to the more general case.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{bothvac <-}\StringTok{ }\NormalTok{cdties }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(test_vacant }\OperatorTok{==}\StringTok{ }\DecValTok{2}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{countylandusedescription =} \KeywordTok{map}\NormalTok{(countylandusedescription, }\DecValTok{1}\NormalTok{),}
         \DataTypeTok{category_detail =} \KeywordTok{map}\NormalTok{(category_detail, }\DecValTok{1}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

Bind all instances back together, check that no observations have gone
missing, and then bind back to full dataset.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{stopifnot}\NormalTok{(}
  \KeywordTok{nrow}\NormalTok{(cdties) }\OperatorTok{==}\StringTok{ }\KeywordTok{nrow}\NormalTok{(}\KeywordTok{bind_rows}\NormalTok{(novac, bothvac, onevac))}
\NormalTok{)}

\NormalTok{nested_final <-}\StringTok{ }\KeywordTok{bind_rows}\NormalTok{(}
  \KeywordTok{filter}\NormalTok{(nested_all, }\KeywordTok{map}\NormalTok{(category_detail, length) }\OperatorTok{<=}\StringTok{ }\DecValTok{1}\NormalTok{),}
\NormalTok{  novac, bothvac, onevac) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{select}\NormalTok{(}\OperatorTok{-}\NormalTok{test_vacant)}

\KeywordTok{stopifnot}\NormalTok{(}\KeywordTok{nrow}\NormalTok{(nested_all) }\OperatorTok{==}\StringTok{ }\KeywordTok{nrow}\NormalTok{(nested_final))}

\KeywordTok{rm}\NormalTok{(novac, onevac, bothvac, nested_all)}
\end{Highlighting}
\end{Shaded}

\subsubsection{Single addresses}\label{single-addresses}

For single addresses, we have to reclassify condos that have a unique
observation as single-family structures, since condos are listed
seperately for each unit

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{count}\NormalTok{(singles, category_detail)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 20 x 2
##    category_detail       n
##    <chr>             <int>
##  1 apartment            73
##  2 commercial         1509
##  3 condo              7629
##  4 duplex              633
##  5 educational         190
##  6 fire department      21
##  7 government           33
##  8 missing               1
##  9 office              359
## 10 other use           352
## 11 recreational         90
## 12 sf detached       66626
## 13 townhouse         36384
## 14 trailer               7
## 15 vacant commercial    23
## 16 vacant office         1
## 17 vacant other       2879
## 18 vacant sf            12
## 19 vacant townhouse     13
## 20 vacant trailer        3
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{singles <-}\StringTok{ }\NormalTok{singles }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{category =} \KeywordTok{ifelse}\NormalTok{(category_detail }\OperatorTok{==}\StringTok{ "condo"}\NormalTok{,}
                           \StringTok{"sf"}\NormalTok{,}
\NormalTok{                           category),}
         \DataTypeTok{category_detail =} \KeywordTok{ifelse}\NormalTok{(category_detail }\OperatorTok{==}\StringTok{ "condo"}\NormalTok{,}
                                  \StringTok{"sf attached"}\NormalTok{,}
\NormalTok{                                  category_detail))}
\end{Highlighting}
\end{Shaded}

\subsection{Recombine and save data}\label{recombine-and-save-data}

The final outputted dataset should not contain nested lists, but should
capture all other relevant information from single and multiple address
properties. First, select approptiate variables from the singles file.
Then, re-introduce rename and transform variables from multiple
addressess and bind dataframes.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{singles_f <-}\StringTok{ }\NormalTok{singles }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{select}\NormalTok{(county_fips, county_name,}
\NormalTok{         assessorsparcelnumberapnpin, }
\NormalTok{         propaddress, propcity, propstate, propzip,}
\NormalTok{         propunitno, prophouseno, propstreetname, propstreetsuffix,}
\NormalTok{         lat, long, tract, owneroccupiedresidential,}
\NormalTok{         countylandusedescription, zoning, buildingarea, noofbuildings,}
\NormalTok{         noofstories, numberofunits, yearbuilt,}
\NormalTok{         lotsize_acres, lotsize_sf, address_type,}
\NormalTok{         category, category_detail, residential, building_type)}

\NormalTok{missing_f <-}\StringTok{ }\NormalTok{missing }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{select}\NormalTok{(county_fips, county_name,}
\NormalTok{         assessorsparcelnumberapnpin, }
\NormalTok{         propaddress, propcity, propstate, propzip,}
\NormalTok{         propunitno, prophouseno, propstreetname, propstreetsuffix,}
\NormalTok{         lat, long, tract, owneroccupiedresidential,}
\NormalTok{         countylandusedescription, zoning, buildingarea, noofbuildings,}
\NormalTok{         noofstories, numberofunits, yearbuilt,}
\NormalTok{         lotsize_acres, lotsize_sf, address_type,}
\NormalTok{         category, category_detail, residential, building_type)}

\NormalTok{multiples_f <-}\StringTok{ }\NormalTok{nested_final }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{select}\NormalTok{(}\OperatorTok{-}\KeywordTok{ends_with}\NormalTok{(}\StringTok{"_list"}\NormalTok{), }\OperatorTok{-}\NormalTok{lsmode, }\OperatorTok{-}\NormalTok{lsfirst, }
         \OperatorTok{-}\NormalTok{lsmode_num, }\OperatorTok{-}\NormalTok{fxn, }\OperatorTok{-}\NormalTok{unique_lots, }\OperatorTok{-}\NormalTok{lotsize_sf_sum) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{mutate_at}\NormalTok{(}\KeywordTok{vars}\NormalTok{(countylandusedescription, zoning,}
\NormalTok{                 category, category_detail, building_type, yearbuilt),}
\NormalTok{            as.character) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{mutate_at}\NormalTok{(}\KeywordTok{vars}\NormalTok{(buildingarea, lat, long, residential), as.double) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{rename}\NormalTok{(}\DataTypeTok{lotsize_sf =}\NormalTok{ lotsize_sf_final, }\DataTypeTok{numberofunits =}\NormalTok{ nprops) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{lotsize_acres =}\NormalTok{ lotsize_sf }\OperatorTok{/}\StringTok{ }\DecValTok{43560}\NormalTok{,}
         \DataTypeTok{address_type =} \StringTok{"multiple"}\NormalTok{)}

\NormalTok{finaljur <-}\StringTok{ }\KeywordTok{bind_rows}\NormalTok{(singles_f, multiples_f, missing_f) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{fill}\NormalTok{(county_fips) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{fill}\NormalTok{(county_name)}
\end{Highlighting}
\end{Shaded}

Run one last check to make sure everything from the initial dataset is
accounted for. We have to account for the fact that the addresses were
collapsed. There were 94 multiple-address parcels that were collapsed
into just 1 unit- so we subtract the number of total units that had
ties, 188, minus 94.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mult <-}\StringTok{ }\NormalTok{finaljur }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(address_type }\OperatorTok{==}\StringTok{ "multiple"}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{summarize}\NormalTok{(}\DataTypeTok{num =} \KeywordTok{sum}\NormalTok{(numberofunits)) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{pull}\NormalTok{()}

\NormalTok{other <-}\StringTok{ }\NormalTok{finaljur }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(address_type }\OperatorTok{!=}\StringTok{ "multiple"}\NormalTok{)}

\KeywordTok{stopifnot}\NormalTok{(mult }\OperatorTok{+}\StringTok{ }\KeywordTok{nrow}\NormalTok{(other) }\OperatorTok{==}\StringTok{ }\KeywordTok{nrow}\NormalTok{(jur) }\OperatorTok{-}\StringTok{ }
\StringTok{            }\NormalTok{(nunits }\OperatorTok{-}\StringTok{ }\KeywordTok{nrow}\NormalTok{(}\KeywordTok{filter}\NormalTok{(cdties, test_vacant }\OperatorTok{==}\StringTok{ }\DecValTok{1}\NormalTok{))))}

\KeywordTok{rm}\NormalTok{(mult, other, nunits, cdties)}
\end{Highlighting}
\end{Shaded}

Write out clean data if you want using the code below. I do not use this
code here because it prevented the Rmarkdown file from knitting.

write\_csv(finaljur, paste0(``../Data/'', filepath,
``-cleaned-data.csv''))


\end{document}
