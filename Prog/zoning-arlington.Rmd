---
title: "Regional Housing Framework"
subtitle: "Identify correct zoning designation"
author: ""
output:
  html_document:
    number_sections: FALSE
    self_contained: TRUE
    code_folding: show
    toc: TRUE
    toc_float: TRUE
    css: ../www/web_report.css
    editor_options:
      chunk_output_type: console
---

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato" />

Library: RegHsg

Project: Regional Housing Framework

Author: Sarah Strochak

Version: R 3.5.1, RStudio 1.1.423

Last updated `r format(Sys.time(), '%B %d, %Y')`

Environment: Local Windows session (desktop)


```{r rmarkdown-setup, echo = FALSE}
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
# knitr::opts_chunk$set(eval = FALSE)
```

## Description

The purpose of this step is to test the zoning designations in the Black Knight data against the Arlington zoning code shapefile, and determine which variable should be used for analysis.

## Set-up

### Black Knight
Load libraries and functions
```{r setup}
library(tidyverse)
library(sf)

source("../Macros/read-jurisdiction.R")

```

Create directory for data exports
```{r dir}
if (!dir.exists("../Data")) {
  dir.create("../Data")
}

```


Set FIPS code and filepath name
```{r fips}
currentfips <- "51013"
filepath <- "arlington"
```

Load in Black Knight data for the region, select jurisdiction and standard variables
```{r read}
if (!exists("jur")) {
  jur <- read_jurisdiction(filepath)
} else {
  warning(filepath, " data already read in")
}

```

### Zoning Map

First, download file if not already downloaded. Use "jurisdiction-zoning-map.zip" for consistency.

```{r download-map}
zzip <- paste0("L:/Libraries/RegHsg/Maps/",
                     filepath,
                     "-zoning-map.zip")
zdir <- paste0("L:/Libraries/RegHsg/Maps/",
               filepath,
               "-zoning-map")

zurl <- "https://gisdata-arlgis.opendata.arcgis.com/datasets/28efb25252b54f1180b703fbcdd2209b_0"

if (!file.exists(zzip)) {
  
  download.file(zurl,
                destfile = zzip)
  
  dir.create(zdir)
  
  unzip(zzip, exdir = zdir)
  
}

zfile <- str_sub(list.files(zdir), end = -5) %>% unique()
```

Repeat process for parcel shapefile if not already downloaded. Use "jurisdiction-parcel-map.zip" for consistency.

```{r get-parcel}

pdir <- paste0("L:/Libraries/RegHsg/Maps/",
               filepath,
               "-parcel-map")
pzip <- paste0("L:/Libraries/RegHsg/Maps/",
               filepath,
               "-parcel-map.zip")

purl <- "https://opendata.arcgis.com/datasets/b70198178ff44462b00c5b5c0012668d_0.zip?outSR=%7B%22wkid%22%3A102746%2C%22latestWkid%22%3A2283%7D"

if (!file.exists(pzip)) {
  
  download.file(purl,
                destfile = pzip)
  
  dir.create(pdir)
  
  unzip(pzip, exdir = pdir)
  
}

pfile <- str_sub(list.files(pdir), end = -5) %>% unique()

```

Read in files as `sf` objects.

```{r read-parcel}

zon <- read_sf(dsn = zdir,
               layer = zfile)

par <- read_sf(dsn = pdir,
               layer = pfile)

rm(purl, pzip, pfile, pdir,
   zurl, zzip, zfile, zdir)

```

Set CRS of both files.
```{r set-crs}
st_geometry(zon)

zon <- st_transform(zon, crs = 4326)
par <- st_transform(par, crs = 4326)

```


Quick map for each to make sure they read in correctly.

#### {.tabset .tabset.fade}

##### zoning map
```{r zon-map}

ggplot(zon) +
  geom_sf(mapping = aes(fill = ZN_DESIG))

```

##### parcel map
```{r par-map}

ggplot(par) +
  geom_sf(mapping = aes())

```

### 

Get centroid of parcels, map on zoning layers.

```{r cent}

par <- par %>% 
  select(-cent)

parc <- st_centroid(par)

# make sample dataset with 500 observations for quick mapping

par1 <- parc %>% sample_n(500, replace = FALSE)

ggplot() +
  geom_sf(data = zon, mapping = aes(fill = ZN_DESIG)) +
  geom_sf(data = par1, mapping = aes())

```

## Merge vacant parcels with parcel centroids

Filter out only the parcels that are vacant. Transform this into an `sf` object.

```{r get-vac}

vacant <- jur %>% 
  filter(category == "vacant")

vacant %>% count(address_type)

vacantsf <- vacant %>% 
  mutate(missingcoord = ifelse(is.na(lat) | is.na(long), 1, 0)) %>% 
  mutate_at(vars(lat, long),
            ~ ifelse(is.na(.), 999, .)) %>% 
  st_as_sf(coords = c("long", "lat")) %>% 
  st_set_crs(st_crs(zon))

vacant <- vacant %>% 
  mutate(parcel_id_merge = ifelse(address_type %in% c("missing", "single"),
                                  assessorsparcelnumberapnpin,
                                  parcel_address))

# check to see that this worked
vacant %>% 
  mutate(len = map_int(parcel_id_merge, str_length)) %>% 
  count(len)

full <- vacant %>%
  filter(address_type %in% c("missing", "other"))

parc <- parc %>% 
  mutate(parcel_id = paste0(substr(RPCMSTR, 1, 2),
                            "-",
                            substr(RPCMSTR, 3, 5),
                            "-", 
                            substr(RPCMSTR, 6, 8)))

full <- full %>% 
  left_join(parc, by = c("parcel_id_merge" = "parcel_id"))

t <- vacant %>% 
  anti_join(parc, by = c("assessorsparcelnumberapnpin" = "parcel_id"))

```

Missing and single addresses should join cleanly with parcel shapefile, once we manipulate the parcel ID variables. For multiple addresses, we can merge on the first five numbers of the parcel ID- which have been stored as `parcel_address` during the cleaning phase.






Spatial join
```{r join}

x <- st_join(vacantsf, zon)

count(x, is.na(ZN_DESIG))

count(x, ZN_DESIG == zoning)

test_zoning <- x %>% 
  mutate(zflag = ifelse(ZN_DESIG == zoning,
                        0,
                        1)) %>% 
  filter(zflag == 1) %>% 
  select(propaddress, zoning, ZN_DESIG,
         category_detail, geometry)
```


Test with more than just vacant properties
```{r test-all}

jursf <- jur %>% 
  filter(!is.na(long), !is.na(lat)) %>% 
  st_as_sf(coords = c("long", "lat")) %>% 
  st_set_crs(st_crs(zon))


y <- st_join(jursf, zon)

count(y, is.na(ZN_DESIG))

test_all <- y %>% 
  mutate(zflag = ifelse(ZN_DESIG == zoning,
                        0,
                        1)) %>% 
  filter(zflag == 1) %>% 
  select(propaddress, zoning, ZN_DESIG,
         category_detail, geometry)
```


