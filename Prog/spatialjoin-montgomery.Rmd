---
title: "postclean-montgomery"
author: "Patrick Spauster"
date: "February 13, 2019"
output: html_document
---

---
title: "Regional Housing Framework"
subtitle: "Pre Clean Arlington County public records data"
author: "Patrick Spauster"
output:
  html_document:
    number_sections: FALSE
    self_contained: TRUE
    code_folding: show
    toc: TRUE
    toc_float: TRUE
    css: ../www/web_report.css
    editor_options:
      chunk_output_type: console
---

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato" />

Library: RegHsg

Project: Regional Housing Framework

Author: Patrick Spauster

Version: R 3.5.1, RStudio 1.1.423

Last updated `r format(Sys.time(), '%B %d, %Y')`

Environment: Local Windows session (desktop)
## Set-up
#### Load libraries and functions
```{r setup}
library(tidyverse)
library(DescTools)
library(purrr)
library(sf)

source("../Macros/read-bk.R")
source("../Macros/filter-bk.R")
source("../Macros/select-vars.R")
source("../Macros/sample-properties.R")
source("../Macros/classify-addresses.R")
```

```{r rmarkdown-setup, echo = FALSE}
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
# knitr::opts_chunk$set(eval = FALSE)
```

#### Set FIPS code and filepath name
```{r fips}
currentfips <- "24031"
filepath <- "montgomery"
jdir <- paste0("L:/Libraries/RegHsg/Data/", filepath, "/")
rdir <- paste0("L:/Libraries/RegHsg/Raw/", filepath, "/")
```

####Create directory for data exports
```{r dir}
if (!dir.exists("../Data")) {
  dir.create("../Data")
}
if (!dir.exists(paste0("L:/Libraries/RegHsg/Raw/", filepath))) {
  dir.create(paste0("L:/Libraries/RegHsg/Raw/", filepath))
}
if (!dir.exists(paste0("L:/Libraries/RegHsg/Data/", filepath))) {
  dir.create(paste0("L:/Libraries/RegHsg/Data/", filepath))
}
```


##Read in the parcel file
```{r readin}
pfile <- str_sub(list.files('L:/Libraries/RegHsg/Raw/montgomery/montgomery-parcel-file/MCzoning_parcels'), end = -5) %>% unique()
parcel_sf <- read_sf(dsn = 'L:/Libraries/RegHsg/Raw/montgomery/montgomery-parcel-file/MCzoning_parcels',
                     layer = pfile[1])

  #jur_par <- jur %>% 
  #  mutate(first2 = substr(assessorsparcelnumberapnpin, 1, 2),
  #         pnlength = str_length(assessorsparcelnumberapnpin))
  #
  #count(jur_par, first2)
  #parcel_f_par <- parcel_sf %>% 
  #  st_set_geometry(NULL) %>% 
  #  mutate(first2 = substr(ACCT, 1, 2),
  #         pnlength = str_length(ACCT))
  #count(parcel_f_par, DISTRICT)
```

####Find the invalid geometries
```{r find bad geometries}

parcel_sf1 <- parcel_sf %>% 
  mutate(validgeo = ifelse(st_is_valid(st_sfc(geometry)),
                                1,
                                0))

parcel_sf1 %>% as.data.frame() %>% 
  count(validgeo)


#count(parcel_sf1, validgeo == 0)


parcel_sf1 <- parcel_sf1 %>% 
  filter(validgeo == 1 & !is.na(validgeo))

```


###clean the dataset and filter out the bad geometries to faciltate a join
```{r clean}
st_geometry(parcel_sf1)

parcel_sf1 <- st_transform(parcel_sf, crs = 4326)

```

##### parcel map
```{r par-map}

plot(st_geometry(parcel_sf))



ggplot(parcel_sf) +
  geom_sf(mapping = aes())

```

## Load in Cleaned Black Knight data and clean the dataset.
```{r read}
jur <- readRDS(paste0(jdir, 
               "cleaned-",
               filepath,
               "-data.Rdata"))
```

####clean and set geometries
```{r clean}
jur1 <- jur %>% 
  mutate(missing_coord = ifelse(is.na(lat) | is.na(long),
                                1,
                                0))
jur_sf <- jur1 %>% 
  filter(missing_coord == 0) %>% 
  st_as_sf(coords = c("long", "lat")) %>% 
  st_set_crs(st_crs(parcel_sf1))

jur_sf1 <- jur_sf %>% 
  mutate(validgeo = ifelse(st_is_valid(st_sfc(geometry)),
                                1,
                                0))
jur_sf1 %>% as.data.frame() %>% 
  count(validgeo)

```



##Spatial Join!
```{r join}

join <- st_join(jur_sf1, parcel_sf1, join = st_intersects)

```
##Test Join
After the join, we convert back to a dataframe, for ease of computations.
```{r back-to-df}

join_df <- st_set_geometry(join, NULL)

```

Count how many observations did not join. This will throw an error if more than 5% did not match- in this case, check the underlying shapefiles for compatability.

```{r count-spatial}

paste0(sum(is.na(join_df$validgeo)), " observations didn't join- ",
      round(sum(is.na(join_df$validgeo)) / nrow(join_df) * 100, 2), "%")

if (sum(is.na(join_df$validgeo)) / nrow(join_df) > .05) {
  stop("More than 5% of observations could not be spatially joined.")
}

paste0(sum(is.na(join_df$ACCT)), " observations didn't join- ",
      round(sum(is.na(join_df$ACCT)) / nrow(join_df) * 100, 2), "%")

if (sum(is.na(join_df$ACCT)) / nrow(join_df) > .05) {
  stop("More than 5% of observations could not be spatially joined.")
}

```


--- left off 2/21/19  ----


Test how many have different results from the Black Knight zoning variable.

```{r test-spatial}

vacant2 %>% 
  group_by(is.na(zoning)) %>% 
  count(zoning == ZN_DESIG)

```


```

##Clean and merge



Select variables from each dataset that we want to keep.

From the parcel file, we will keep the area of the parcel shapefile to use in the event that the Black Knight lot size is unavailable or incorrect.
We also archive the raw parcel ID and create a new version that will merge with the Black Knight data.

```{r select-parcel}
parcel_clean <- parcel_sf %>% 
  select(raw_parcelid_par = ACCT,
         parcel_area = SHAPE_AREA, 
         parcel_length = SHAPE_LEN,
         raw_parcelid_d = DISTRICT,
         parcel_category= LU_CATEGOR) %>% 
  mutate(parcel_id = paste0(raw_parcelid_d,
                            "-",
                            raw_parcelid_par)) %>% 
  filter(!is.na(raw_parcelid_par))


```

```{r strip the geometry}
parcel_cleandf <- st_set_geometry(parcel_clean, NULL)

```

There are `r parcel %>% group_by(parcel_id) %>% filter(n()>1) %>% nrow()` parcels that show up more than once on the parcel file. We combine these by taking the average area and width. 

```{r dups-parcel}
parcel_cleandf <- parcel_cleandf %>% 
  group_by(parcel_id, raw_parcelid_par) %>% 
  summarize(parcel_area = mean(parcel_area),
            parcel_length = mean(parcel_area)) %>% 
  ungroup()

count(parcel_cleandf, parcel_category)
```


Merge

```{r merge}
jur <- left_join(jur, parcel_cleandf, 
                 by = c("assessorsparcelnumberapnpin" = "parcel_id"))

test <- anti_join(jur, parcel_cleandf, 
                 by = c("assessorsparcelnumberapnpin" = "parcel_id"))


```