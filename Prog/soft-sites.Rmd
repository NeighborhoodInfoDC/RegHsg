---
title: "Regional Housing Framework"
subtitle: "Soft sites analysis for all jurisdictions"
author: ""
output:
  html_document:
    number_sections: FALSE
    self_contained: TRUE
    code_folding: show
    toc: TRUE
    toc_float: TRUE
    css: ../www/web_report.css
    editor_options:
      chunk_output_type: console
---

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato" />

Library: RegHsg

Project: Regional Housing Framework

Author: Sarah Strochak

Version: R 3.5.1, RStudio 1.1.423

Last updated `r format(Sys.time(), '%B %d, %Y')`

Environment: Local Windows session (desktop)


```{r rmarkdown-setup, echo = FALSE}
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
# knitr::opts_chunk$set(eval = FALSE)
```

## Description

The goal of this analysis is to determine which sites are underutilized, and estimate how many units could be added by increasing the utilization. "Underutilized" is defined as built to 30 percent of less of the maximum capacity of the lot, based on zoning code.

## Set-up

Load libraries and functions

```{r setup}

library(tidyverse)
library(urbnthemes)

set_urbn_defaults("print")

source("../Macros/read-combined-parcels.R")

```

## Get maximum unit data for each jurisdiction.

Read in parcel data that has filled in units.

```{r parcel}

parcel <- read_combined_parcels()

```


Read in each maximum unit dataset.

```{r get-max-units}
mudir <- "L:/Libraries/RegHsg/Data/"

arlbr <- readRDS(paste0(mudir,
                        "/arlington/arlington-max-units-br.Rdata")) %>% 
  ungroup() %>% 
  select(county_fips, county_name,
         assessorsparcelnumberapnpin,
         propaddress, propcity, propstate,
         zoning_code,
         units_total, units_height, units_lotsize) %>% 
  mutate(jurisdiction = "Arlington by right")
  


arlse <- readRDS(paste0(mudir,
                        "/arlington/arlington-max-units-se.Rdata"))  %>% 
  ungroup() %>% 
  select(county_fips, county_name,
           assessorsparcelnumberapnpin,
           propaddress, propcity,
           zoning_code,
           units_total, units_height, units_lotsize) %>% 
  mutate(jurisdiction = "Arlington special exception")

mont <- readRDS(paste0(mudir,
                       "/montgomery/montgomery-max-units.Rdata")) %>% 
  ungroup() %>% 
  select(county_fips, county_name,
         assessorsparcelnumberapnpin,
         propaddress, propcity,
         zoning_code,
         units_total, units_height, units_lotsize,
         units_FAR, units_height) %>% 
  mutate(jurisdiction = "Montgomery")

rock <- readRDS(paste0(mudir,
                       "/montgomery/Rockville-max-units.Rdata")) %>% 
  ungroup() %>% 
  select(county_fips, county_name,
         assessorsparcelnumberapnpin,
         propaddress, propcity,
         zoning_code,
         units_total, units_height)  %>% 
  mutate(jurisdiction = "Rockville")

gait <- readRDS(paste0(mudir,
                       "/montgomery/Gaithersburg-max-units.Rdata")) %>% 
  ungroup() %>% 
  select(county_fips, county_name,
         assessorsparcelnumberapnpin,
         propaddress, propcity,
         zoning_code,
         units_total, units_height, units_density,
         units_lotsize)  %>% 
  mutate(jurisdiction = "Gaithersburg")

fair <- readRDS(paste0(mudir,
                       "/fairfax/fairfax-max-units.Rdata")) %>% 
  ungroup() %>% 
  select(county_fips, county_name,
         assessorsparcelnumberapnpin,
         propaddress, propcity,
         zoning_code,
         units_total, units_height, units_lotsize) %>% 
  mutate(county_fips = as.character(county_fips))  %>% 
  mutate(jurisdiction = "Fairfax")

dc <- readRDS(paste0(mudir,
                       "/DC/DC-max-units.Rdata")) %>% 
  ungroup() %>% 
  select(county_fips, county_name,
         assessorsparcelnumberapnpin = parcelbase_SSL,
         propaddress, propcity,
         zoning_code,
         units_FAR, units_height, units_total)  %>% 
  mutate(jurisdiction = "DC")

```

Combine- except for DC, which must be merged and then combined.

```{r combine}

maxunits <- bind_rows(fair, mont, rock, gait, arlbr, arlse, dc)

```



```{r merge}

allmax <- maxunits %>% 
  left_join(parcel,
            by = c("county_fips", "county_name",
                   "assessorsparcelnumberapnpin",
                   "propaddress", "propcity"))

g <- allmax %>% 
   filter(jurisdiction == "Gaithersburg",
          category == "mf")

```

## Identify underutilized parcels

### Multifamily

```{r mf}

mfmax <- allmax %>% 
  filter(category == "mf",
         !is.na(numberofunits),
         !is.na(lotsize_sf),
         !is.na(units_total)) %>% 
  mutate(putil = numberofunits / units_total,
         under = ifelse(numberofunits / units_total < 1,
                          1,
                          0),
         under30 = ifelse(numberofunits / units_total < .3,
                          1,
                          0),
         units_behind = ifelse(units_total > numberofunits,
                               units_total - numberofunits,
                               0))

mfsum <- mfmax %>% 
  group_by(jurisdiction) %>% 
  summarize(total_mf = n(),
            total_units = sum(numberofunits),
            under = sum(under),
            punder = sum(under) / n(),
            under30 = sum(under30),
            punder30 = sum(under30) / n(),
            units_behind = sum(units_behind))
knitr::kable(mfsum)
write_csv(mfsum, "L:/Libraries/RegHsg/Prog/Tables/soft-sites-mf.csv")

mfmax %>% 
  filter(putil < 1, putil > 0,
         # jurisdiction != "Gaithersburg",
         jurisdiction != "Arlington by right") %>% 
  ggplot() +
  geom_histogram(mapping = aes(putil)) +
  scale_x_continuous(labels = scales::percent_format(accuracy = 1)) +
  scale_y_continuous(expand = expand_scale(mult = c(0,0.1))) +
  facet_wrap(~county_name) +
  labs(x = "Percent of maximum capacity",
       title = "Utilization distribution for under-utilized land")

```



### Arlington

### DC

### Montgomery

### Fairfax

