---
title: "Regional Housing Framework"
subtitle: "Clean Arlington County public records data"
author: ""
output:
  html_document:
    number_sections: FALSE
    self_contained: TRUE
    code_folding: show
    toc: TRUE
    toc_float: TRUE
    css: ../www/web_report.css
    editor_options:
      chunk_output_type: console
---

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato" />

Library: RegHsg

Project: Regional Housing Framework

Author: Sarah Strochak

Version: R 3.5.1, RStudio 1.1.423

Last updated `r format(Sys.time(), '%B %d, %Y')`

Environment: Local Windows session (desktop)


```{r rmarkdown-setup, echo = FALSE}
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
# knitr::opts_chunk$set(eval = FALSE)
```

## Description

There are three main goals of the jurisdiction level cleaning process:

1. Recategorize the county land use codes into more general codes

2. Collapse observations at the address level

3. Clean the variables needed to provide density estimates


## Set-up
Load libraries and functions
```{r setup}
library(tidyverse)
library(DescTools)
library(purrr)

source("../Macros/read-bk.R")
source("../Macros/filter-bk.R")
source("../Macros/select-vars.R")

```
Create directory for data exports
```{r dir}
if (!dir.exists("../Data")) {
  dir.create("../Data")
}

```


Set FIPS code and filepath name
```{r fips}
currentfips <- "51013"
filepath <- "arlington"
```

Load in Black Knight data for the region, select jurisdiction and standard variables
```{r read}
if (!exists("region")) {
  region <- read_bk("dc-cog-assessment_20181228.csv")
} else {
  warning("region data already read in")
}

jur <- region %>% 
  filter_bk(fips = currentfips) %>% 
  select_vars()

```
## Download files

Arlington has several files of use
- Parcel-level file, could provide alternative lot area metric
- Property file, can account for missing address/other geographic information

```{r download-data}
jdir <- paste0("L:/Libraries/RegHsg/Data/", filepath)
pafile <- paste0(jdir, "/", filepath, "-parcel-file.csv")
prfile <- paste0(jdir, "/", filepath, "-property-file.csv")

if (!dir.exists(jdir)) {
  
  dir.create(jdir)

}

# parcel file
if (!file.exists(pafile)) {
  download.file("https://data.arlingtonva.us/rest/datastreams/258223/data.csv",
                destfile = pafile)
}

# property file
if (!file.exists(prfile)) {
  download.file("https://data.arlingtonva.us/rest/datastreams/255011/data.csv",
                destfile = prfile)
}

```
## Read files

```{r read}

parcel <- read_csv(pafile) %>% 
  select(-`-`, -`-_1`)

property <- read_csv(prfile,
                     col_types = cols(
  provalLrsnId = col_double(),
  hubEffectiveDtm = col_datetime(format = ""),
  hubExpirationDtm = col_logical(),
  realEstatePropertyCode = col_character(),
  reasPropertyStatusCode = col_character(),
  propertyClassTypeCode = col_double(),
  propertyClassTypeDsc = col_character(),
  legalDsc = col_character(),
  lotSizeQty = col_double(),
  mapBookPageNbr = col_character(),
  neighborhoodNbr = col_double(),
  polygonId = col_character(),
  propertyStreetNbrNameText = col_character(),
  propertyStreetNbr = col_double(),
  propertyStreetNbrSuffixCode = col_character(),
  propertyStreetDirectionPrefixCode = col_character(),
  propertyStreetName = col_character(),
  propertyStreetTypeCode = col_character(),
  propertyStreetDirectionSuffixCode = col_character(),
  propertyUnitNbr = col_character(),
  propertyCityName = col_character(),
  propertyZipCode = col_double(),
  gisStreetCode = col_character(),
  physicalAddressPrimeInd = col_logical(),
  zoningDescListText = col_character(),
  tradeName = col_character(),
  ownerStreetText = col_character(),
  ownerCityName = col_character(),
  ownerStateCode = col_character(),
  ownerZipCode = col_character(),
  propertyYearBuilt = col_double(),
  grossFloorAreaSquareFeetQty = col_double(),
  effectiveAgeYearDate = col_double(),
  numberOfUnitsCnt = col_integer(),
  storyHeightCnt = col_double(),
  valuationYearDate = col_double(),
  commercialPropertyTypeDsc = col_character(),
  economicUnitNbr = col_character(),
  condoModelName = col_character(),
  condoStyleName = col_character(),
  finishedStorageAreaSquareFeetQty = col_integer(),
  storageAreaSquareFeetQty = col_integer(),
  unitNbr = col_character(),
  propertyKey = col_double(),
  reasPropertyOwnerKey = col_double(),
  arlingtonStreetKey = col_double(),
  propertyExpiredInd = col_logical(),
  mixedUseInd = col_logical(),
  commercialInd = col_logical(),
  districtNbr = col_character(),
  taxExemptionTypeDsc = col_character(),
  condominiumProjectName = col_character(),
  masterRealEstatePropertyCode = col_character(),
  streetNbrOrder = col_double(),
  resourceProtectionAreaInd = col_logical(),
  statePlaneXCrd = col_double(),
  statePlaneYCrd = col_double(),
  latitudeCrd = col_double(),
  longitudeCrd = col_double(),
  physicalAddressKey = col_double()
)
)

```

## Clean and merge

Select variables from each dataset that we want to keep.

From the parcel file, we will keep the area of the parcel shapefile to use in the event that the Black Knight lot size is unavailable or incorrect.
We also archive the raw parcel ID and create a new version that will merge with the Black Knight data.

```{r select-parcel}
parcel <- parcel %>% 
  select(raw_parcelid_par = RPCMSTR,
         parcel_area = SHAPESTArea, 
         parcel_length = SHAPESTLength) %>% 
  mutate(parcel_id = paste0(substr(raw_parcelid_par, 1, 2),
                            "-",
                            substr(raw_parcelid_par, 3, 5),
                            "-", 
                            substr(raw_parcelid_par, 6, 8)))

```

From the property file, we will save the address, the number of units, and the latitude and longitude.
```{r select-prop}
property <- property %>% 
  select(raw_parcelid_prop = realEstatePropertyCode,
         lotsize_prop = lotSizeQty,
         propaddress_prop = propertyStreetNbrNameText,
         numberofunits_prop = numberOfUnitsCnt,
         lat_prop = latitudeCrd,
         long_prop = longitudeCrd) %>% 
  mutate(parcel_id = paste0(substr(raw_parcelid_prop, 1, 2),
                            "-",
                            substr(raw_parcelid_prop, 3, 5),
                            "-", 
                            substr(raw_parcelid_prop, 6, 8)))

```



Merge

## Save
