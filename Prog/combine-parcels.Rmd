---
title: "Regional Housing Framework"
subtitle: "Combining Parcels"
author: ""
output:
  html_document:
    number_sections: FALSE
    self_contained: TRUE
    code_folding: show
    toc: TRUE
    toc_float: TRUE
    css: ../www/web_report.css
    editor_options:
      chunk_output_type: console
---

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato" />

Library: RegHsg

Project: Regional Housing Framework

Author: Chris Davis, adapting from Sarah Strochak

Version: R 3.5.1, RStudio 1.1.423

Last updated `r format(Sys.time(), '%B %d, %Y')`

Environment: Local Windows session (desktop)


```{r rmarkdown-setup, echo = FALSE}
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
# knitr::opts_chunk$set(eval = FALSE)
```
## Description

The goal of this analysis is to combine parcels for Sarah.

## Set-up

Load libraries and functions
```{r setup}
library(tidyverse)
library(sf)

source("../Macros/read-fairfax.R")
source("../Macros/read-arlington.R")
source("../Macros/read-montgomery.R")
source("../Macros/read-DC.R")

```

## Read each jurisdiction

Set filepath name
```{r fips-fair}

filepath <- "fairfax"

```

Load in cleaned Black Knight data for `r str_to_title(filepath)` County.

```{r readfair}
if (!exists("fairfax")) {
 fairfax <- read_fairfax()
} else {
  warning(filepath, " data already read in")
}

```

Set filepath name
```{r fips-dc}

filepath <- "DC"

```

Load in cleaned Black Knight data for `r str_to_title(filepath)` County.

```{r read-dc}
if (!exists("dc_full")) {
 dc_full <- read_dc()
} else {
  warning(filepath, " data already read in")
}

```

Set filepath name
```{r fips-mon}

filepath <- "montgomery"

```

Load in cleaned Black Knight data for `r str_to_title(filepath)` County.

```{r read-mon}
if (!exists("montgomery")) {
 montgomery <- read_montgomery()
} else {
  warning(filepath, " data already read in")
}

```

Set filepath name
```{r fips-arl}

filepath <- "arlington"

```

Load in cleaned Black Knight data for `r str_to_title(filepath)` County.

```{r read-arl}
if (!exists("arlington")) {
 arlington <- read_arlington()
} else {
  warning(filepath, " data already read in")
}

```


## Fill in variables

For each jurisdiction:

* Fill in missing variables
* Select variables needed for upzoning and soft sites analysis

### Missing units functions

Function to sum missing units 

```{r missing-fxn-units}

sum_missing_units <- function(dataset) {
  
  dataset %>% 
    group_by(category_detail) %>% 
    filter(residential == 1, category != "vacant") %>% 
    summarize(count = n(),
              units.na = sum(is.na(numberofunits)),
              units.zero = sum(numberofunits == 0, na.rm = TRUE),
              p.na = units.na / n(),
              p.zero = units.zero / n())
}


```

Function to sum missing lotsize 

```{r missing-fxn-ls}
sum_missing_lotsize <- function(dataset) {
  
  dataset %>% 
    group_by(category_detail) %>% 
    filter(residential == 1, category != "vacant") %>% 
    summarize(count = n(),
              lotsize.na = sum(is.na(lotsize_sf)),
              lotsize.zero = sum(lotsize_sf == 0, na.rm = TRUE),
              p.na = lotsize.na / n(),
              p.zero = lotsize.zero / n())
}


```

### Arlington

#### Number of units

```{r arl-missing}

arlington %>% 
  sum_missing_units() %>% 
  knitr::kable()

```

Fill in lot size with variables from parcel file, property file. Fill in number of units as 2 for duplex, 1 for single-family. If `numberofunits` is stil missing after those steps, supplement with the `numberofunits_prop` variable, which came from the county. (See `preclean-Arlington.Rmd`)

```{r arl-fill}

arlington1 <- arlington %>% 
  mutate(numberofunits = ifelse(category_detail == "duplex" & numberofunits == 0,
                                2,
                                numberofunits),
         numberofunits = ifelse(category == "sf" & address_type == "single",
                                1,
                                numberofunits),
         numberofunits = ifelse((is.na(numberofunits) | numberofunits == 0) & !is.na(numberofunits_prop),
                                numberofunits_prop,
                                numberofunits))

arlington1 %>% 
  sum_missing_units() %>% 
  knitr::kable()

```

Join to address file to fill in missing apartments.

```{r address-file}

add <- read_csv("https://data.arlingtonva.us/rest/datastreams/254138/data.csv")
names(add) <- tolower(names(add))

add1 <- add %>% 
  mutate(address_cap = toupper(full_address)) %>% 
  select(address_cap, unitcount)

arlingtonjoin <- arlington1 %>% 
  mutate(address_cap = toupper(propaddress)) %>% 
  left_join(add1, by = "address_cap")

# check how many didn't join
arlington1 %>% 
  mutate(address_cap = toupper(propaddress)) %>% 
  anti_join(add1, by = "address_cap") %>% 
  nrow()


arlington2 <- arlingtonjoin %>% 
  mutate(numberofunits = ifelse(numberofunits == 0 & unitcount != 0 & !is.na(unitcount),
                                unitcount,
                                numberofunits)) %>% 
  select(-unitcount)

arlington2 %>% 
  sum_missing_units() %>% 
  knitr::kable()

```



#### Lot size

Fill in with parcel shapefile area and lot size from property file.

```{r arl-ls}

arlington3 <- arlington2 %>% 
  mutate(lotsize_sf = ifelse((is.na(lotsize_sf) | lotsize_sf == 0) & !is.na(parcel_area),
                             parcel_area,
                             lotsize_sf),
         lotsize_sf = ifelse((is.na(lotsize_sf) | lotsize_sf == 0) & !is.na(lotsize_prop),
                             lotsize_prop,
                             lotsize_sf),
         lotsize_acres = lotsize_sf / 43560)


arlington3 %>% 
  sum_missing_lotsize() %>% 
  knitr::kable()


```

Spatial join to parcel file to fill in remaining missing lot size.

```{r spat-arlington}

par <- st_read(dsn = "L:/Libraries/RegHsg/Maps/arlington-parcel-map",
               layer = "Parcel_Polygons") %>% 
  st_transform(crs = 4326)

# calculate area in square feet
par <- par %>% 
  mutate(area = st_area(par) %>% units::set_units("feet^2") %>% units::set_units(NULL))


# convert arlington to spatial
arlsf <- arlington3 %>% 
  filter(!is.na(lat), !is.na(long)) %>% 
  mutate(longx = long, laty = lat) %>% 
  st_as_sf(coords = c("longx", "laty")) %>% 
  st_set_crs(st_crs(4326))

# join to zoning layer

arlj <- st_join(arlsf, par, st_intersects)

# check match rate
arlj %>% 
  as.data.frame() %>% 
  count(is.na(OBJECTID))

arlington4 <- arlj %>% 
  # strip geometry
  st_set_geometry(NULL) %>% 
  mutate(lotsize_sf = ifelse(lotsize_sf == 0 & !is.na(OBJECTID),
                             area,
                             lotsize_sf)) %>% 
  select(-OBJECTID, -EVENT_ID, -RPCMSTR) %>% 
  bind_rows(filter(arlington2, is.na(lat)))

arlington4 %>% 
  sum_missing_lotsize() %>% 
  knitr::kable()

```

### Fairfax

#### Number of units

```{r ff-tab}

fairfax %>% 
  sum_missing_units() %>% 
  knitr::kable()

```

Fill in duplex, SF, and townhouse.
```{r ff-sf}

fairfax1 <- fairfax %>% 
  mutate(numberofunits = ifelse(category_detail == "duplex" & numberofunits == 0,
                                2,
                                numberofunits),
         numberofunits = ifelse(category_detail == "townhouse" & address_type == "single",
                                1,
                                numberofunits),
         numberofunits = ifelse(category == "sf" & address_type == "single",
                                1,
                                numberofunits))

fairfax1 %>% 
  sum_missing_units() %>% 
  knitr::kable()

```

Look at all the additional units variables.

```{r ff-units}

fairfax %>% 
  filter(residential == 1, category != "vacant") %>% 
  group_by(category_detail) %>% 
  summarize_at(vars(numberofunits, num_livunit, dwellings_per_parcel,
                    units_area, numberofunits_tax),
               ~ sum(is.na(.)) / n()) %>% 
  knitr::kable()

```

Fill in with `num_livunit`, and then `numberofunits_tax` when possible.

```{r ff-mf}

fairfax2 <- fairfax1 %>% 
  mutate(numberofunits = ifelse(numberofunits == 0 & !is.na(num_livunit),
                                num_livunit,
                                numberofunits),
         numberofunits = ifelse(numberofunits == 0 & !is.na(numberofunits_tax),
                                numberofunits_tax,
                                numberofunits))

fairfax2 %>% 
  sum_missing_units() %>% 
  knitr::kable()

```

#### Lot size

```{r ff-ls}

fairfax2 %>% 
  sum_missing_lotsize() %>% 
  knitr::kable()

fairfax2 %>% 
  group_by(category_detail) %>% 
  summarize_at(vars(area_tax, parcel_area, sf_area),
               ~ sum(is.na(.)) / n()) %>% 
  knitr::kable()

```

Fill in where possible.

```{r ff-fill-ls}

fairfax3 <- fairfax2 %>% 
  mutate(lotsize_sf = ifelse(is.na(lotsize_sf) & !is.na(parcel_area) & parcel_area != 0,
                             parcel_area,
                             lotsize_sf),
         lotsize_sf = ifelse(is.na(lotsize_sf) & !is.na(area_tax) & area_tax != 0,
                             area_tax,
                             lotsize_sf),
         lotsize_sf = as.numeric(lotsize_sf),
         lotsize_acres = lotsize_sf / 43560)

fairfax3 %>% 
  sum_missing_lotsize() %>% 
  knitr::kable()

```

### Montgomery

#### Number of units

Fill in single family with 1

```{r mont-tab}

montgomery1 <- montgomery %>% 
  mutate(numberofunits = ifelse(category_detail == "sf detached" & 
                                  numberofunits == 0,
                                1,
                                numberofunits))

montgomery1 %>% 
  sum_missing_units() %>% 
  knitr::kable()

```

#### Lot size

```{r mont-ls}

montgomery1 %>% 
  sum_missing_lotsize() %>% 
  knitr::kable()

```

### DC

#### Number of units

Units were already filled for rental properties in `clean-DC.Rmd`. Fill in single family homes.

```{r dc-tab}

dc1 <- dc_full %>% 
  mutate(numberofunits = ifelse(is.na(numberofunits) & 
                                  category_detail == "Single-family home" &
                                  address_type %in% c("single", "missing"),
                                1,
                                numberofunits))

dc1 %>% 
  sum_missing_units() %>% 
  knitr::kable()
  
```

#### Lot size

```{r dc-ls}

dc1 %>% 
  sum_missing_lotsize() %>% 
  knitr::kable()

```

## Select and combine

```{r}
arl <- arlington4 %>%
          select(county_fips,
                 county_name,
                 assessorsparcelnumberapnpin,
                 propaddress,
                 propcity,
                 address_type,
                 zoning, 
                 lotsize_sf, 
                 numberofunits,
                 category,
                 category_detail, 
                 countylandusedescription, 
                 residential, lat, long) %>% 
  mutate(numberofunits = as.integer(numberofunits))

fai <- fairfax3 %>%
        select(county_fips,
               county_name,
               assessorsparcelnumberapnpin,
               propaddress,
               propcity,
               address_type,
               zoning, 
               lotsize_sf, 
               numberofunits,
               category,
               category_detail, 
               countylandusedescription, 
               residential, lat, long)

mon <- montgomery1 %>%
        select(county_fips,
               county_name,
               assessorsparcelnumberapnpin,
               propaddress,
               propcity,
               address_type,
               zoning, 
               lotsize_sf, 
               numberofunits,
               category,
               category_detail, 
               countylandusedescription, 
               residential, 
               lat = latarc, 
               long = longarc)

dc <- dc1 %>%
    select(county_fips,
           county_name,
           assessorsparcelnumberapnpin = parcelbase_SSL,
           propcity,
           address_type,           
           zoning, 
           lotsize_sf, 
           numberofunits, 
           category,
           category_detail, 
           propaddress = parcelbase_address, 
           countylandusedescription, 
           residential, 
           lat, long,
           parcelgeo_x, parcelgeo_y)

```

Bind rows together
```{r}

all_jurs <- arl %>% 
  bind_rows(fai) %>%
  bind_rows(mon) %>%
  bind_rows(dc) %>% 
  mutate_at(vars(lotsize_sf, numberofunits),
            ~ ifelse(. == 0, NA, .)) %>% 
  mutate(lotsize_acres = lotsize_sf / 43560)
            

```

Look at combined missing variables.

```{r com-missing}

all_jurs %>% 
  sum_missing_units() %>% 
  knitr::kable(caption = "Missing units for all jurisdictions")


all_jurs %>% 
  sum_missing_lotsize() %>% 
  knitr::kable(caption = "Missing lot size for all jurisdictions")


all_jurs %>% 
  filter(category != "vacant", residential == 1) %>% 
  summarize(sum(is.na(numberofunits)) / n(),
            sum(is.na(lotsize_sf))/ n())

```


Write out data
```{r write-all}

write_csv(all_jurs, "L:/Libraries/RegHsg/Data/parcel-all-cleaned-data.csv")

```


