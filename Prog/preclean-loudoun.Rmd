---
title: "Regional Housing Framework"
author: ''
subtitle: Pre-clean Loudoun County public records data
output:
  html_document:
    code_folding: show
    css: ../www/web_report.css
    editor_options:
      chunk_output_type: console
    number_sections: no
    self_contained: yes
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes
---

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato" />

Library: RegHsg

Project: Regional Housing Framework

Author: Sarah Strochak, Adapted by Kassie Scott, Rob Pitingolo and Chris Davis

Version: R 3.5.1, RStudio 1.1.423

Last updated `r format(Sys.time(), '%B %d, %Y')`

Environment: Local Windows session (desktop)


```{r rmarkdown-setup, echo = FALSE}
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
# knitr::opts_chunk$set(eval = FALSE)
```

## Description

The purpose of this program is to obtain additional data from the county to supplement the Black Knight data when possible.

## Set-up
Load libraries and functions
```{r setup}
library(tidyverse)

source("../Macros/read-bk.R")
source("../Macros/filter-bk.R")
source("../Macros/select-vars.R")

```


Set FIPS code, filepath name, and directory for data storage (on L drive)

```{r fips}
currentfips <- "51107"
filepath <- "loudoun"
jdir <- paste0("L:/Libraries/RegHsg/Data/", filepath, "/")
rdir <- paste0("L:/Libraries/RegHsg/Raw/", filepath, "/")


```


Create directory for data exports
```{r dir}
if (!dir.exists("../Data")) {
  dir.create("../Data")
}

if (!dir.exists(paste0("L:/Libraries/RegHsg/Raw/", filepath))) {
  dir.create(paste0("L:/Libraries/RegHsg/Raw/", filepath))
}

if (!dir.exists(paste0("L:/Libraries/RegHsg/Data/", filepath))) {
  dir.create(paste0("L:/Libraries/RegHsg/Data/", filepath))
}
```

Load in Black Knight data for the region, select jurisdiction and standard variables
```{r read}
if (!exists("region")) {
  region <- read_bk("dc-cog-assessment_20181228.csv")
} else {
  warning("region data already read in")
}

jur <- region %>% 
  filter_bk(fips = currentfips) %>% 
  select_vars()

```
## Download files

Loudoun has files on Loudoun's parcels and landuse existing parcels, among others, but I selected these two. 

```{r download-data}
pafile <- paste0(rdir, filepath, "-parcel-file.csv")
prfile <- paste0(rdir, filepath, "-property-file.csv")

# parcel file
if (!file.exists(pafile)) {
  download.file("http://geohub-loudoungis.opendata.arcgis.com/datasets/940679f5fe8444699893a1ed7bb7c2c6_5.csv",
                destfile = pafile)
}

# property file
if (!file.exists(prfile)) {
  download.file("http://geohub-loudoungis.opendata.arcgis.com/datasets/5ef377801d824cd0b483d800f862675d_1.csv",
                destfile = prfile)
}

```


## Read files
```{r read-files}

property <- read_csv(prfile,
                     col_types = cols(
  OBJECTID = col_double(),
  LU_PIN = col_double(),
  LU_USE = col_character(),
  LU_MULTI_USE_SUBCD1 = col_character(),
  LU_AGE_RESTRICT = col_character(),
  LU_HUNITS_EXIST = col_double(),
  LU_GIS_ACRE = col_double(),
  LU_LEGAL_ACRE = col_double(),
  LU_DEVELOPABLE_PCT = col_double(),
  LU_NON_RES_SQ_FT = col_double(),
  LU_AS_OF_DATE = col_character(),
  LU_DISPLAY = col_character(),
  LU_TYPE = col_character(),
  LU_USE_CONSOLIDATED = col_character()
))

parcel <- read_csv(pafile,
                   col_types = cols(
OBJECTID = col_double(),
PA_TYPE = col_character(),
PA_UNITS = col_integer(),
PA_PLAT_NUM = col_character(),
PA_PLAT_LOT = col_character(),
PA_GIS_ACRE = col_double(),
PA_LEGAL_ACRE = col_double(),
PA_SUBD_NAME = col_character(),
PA_SUBD_PHASE = col_character(),
PA_SUBD_SECT = col_character(),
PA_SUBD_BLOCK = col_character(),
PA_LEGAL_SQFT = col_double(),
PA_UPD_DATE = col_datetime(format = ""),
PA_MCPI = col_double(),
SHAPE_Length = col_double(),
SHAPE_Area = col_double()

                   ))

rm(prfile, pafile)

```

## Clean and merge

Select variables from each dataset that we want to keep.

From the parcel file, we will keep the area of the parcel shapefile to use in the event that the Black Knight lot size is unavailable or incorrect. We also select a lot size variable for comparison, and keep the number of units varaibles.
We also archive the raw parcel ID and create a new version that will merge with the Black Knight data.

```{r select-parcel}
parcel2 <- parcel %>% 
  select(raw_parcelid_par = PA_MCPI,
         units_par = PA_UNITS,
         lotsize_acres_par = PA_GIS_ACRE,
         parcel_area = SHAPE_Area, 
         parcel_length = SHAPE_Length) %>% 
  mutate(parcel_idz = str_pad(raw_parcelid_par, 12, side = "left", pad = "0")) %>% 
  mutate(parcel_id = paste0(substr(parcel_idz, 1, 3),
                            "-",
                            substr(parcel_idz, 4, 5),
                            "-", 
                            substr(parcel_idz, 6, 9),
                            "-",
                            substr(parcel_idz, 10, 12))) %>% 
  filter(!is.na(raw_parcelid_par))

```

Collapse at the parcel level, sum parcels that have multiple disconnected geographies.

```{r dups-parcel}

parcel_clean <- parcel2 %>% 
  group_by(parcel_id, raw_parcelid_par) %>% 
  summarize(parcel_area = sum(parcel_area),
            parcel_length = sum(parcel_area)) %>% 
  ungroup()

```

From the property file, we will save the numer of units, the land use, a lot size variable, and a residential indicator. Variables are given the suffiz `prop` to indicate their source.

```{r select-prop}
property <- property %>% 
  select(raw_parcelid_prop = LU_PIN,
         lotsize_acres_prop = LU_LEGAL_ACRE,
         numberofunits_prop = LU_HUNITS_EXIST,
         propertytype_par = LU_DISPLAY,
         landusetype_prop = LU_TYPE) %>% 
  mutate(prop_idz = str_pad(raw_parcelid_prop, 12, side = "left", pad = "0")) %>% 
  mutate(parcel_id = paste0(substr(prop_idz, 1, 3),
                            "-",
                            substr(prop_idz, 4, 5),
                            "-", 
                            substr(prop_idz, 6, 9),
                            "-",
                            substr(prop_idz, 10, 12)))

```

Merge

```{r merge}


jur1 <- left_join(jur, parcel_clean, 
                 by = c("assessorsparcelnumberapnpin" = "parcel_id"))

jur2 <- left_join(jur1, property, 
                 by = c("assessorsparcelnumberapnpin" = "parcel_id"))

jurfin <- jur2 %>% select(-prop_idz)

```

## Save

Since this is an intermediary dataset, save as an R dataset for easy reading into the the next step in the cleaning.

```{r save}
saveRDS(jurfin,
        paste0(jdir, 
               "precleaned-",
               filepath,
               "-data.Rdata"))
```