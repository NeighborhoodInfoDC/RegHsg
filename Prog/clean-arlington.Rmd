---
title: "Regional Housing Framework"
subtitle: "Clean Arlington County public records data"
author: ""
output:
  html_document:
    number_sections: FALSE
    self_contained: TRUE
    code_folding: show
    toc: TRUE
    toc_float: TRUE
    css: ../www/web_report.css
    editor_options:
      chunk_output_type: console
---

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato" />

Library: RegHsg

Project: Regional Housing Framework

Author: Sarah Strochak

Version: R 3.5.1, RStudio 1.1.423

Last updated `r format(Sys.time(), '%B %d, %Y')`

Environment: Local Windows session (desktop)


```{r rmarkdown-setup, echo = FALSE}
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
 knitr::opts_chunk$set(eval = FALSE)
```

## Description

There are three main goals of the jurisdiction level cleaning process:
1. Recategorize the county land use codes into more general codes
2. Collapse observations at the address level
3. Clean the variables needed to provide density estimates

## Set-up
### Load libraries and functions
```{r setup}
library(tidyverse)
library(DescTools)
library(purrr)

source("../Macros/read-bk.R")
source("../Macros/filter-bk.R")
source("../Macros/select-vars.R")
source("../Macros/sample-properties.R")
source("../Macros/collapse-properties.R")
```

#### Set FIPS code and filepath name
```{r fips}
currentfips <- "51013"
filepath <- "arlington"
```

#### Load in Black Knight data for the region, select jurisdiction and standard variables
```{r read}
if (!exists("region")) {
  region <- read_bk_rmd("dc-cog-assessment_20181228.csv")
} else {
  warning("region data already read in")
}

currentjur <- region %>% 
  filter_bk(fips = currentfips) %>% 
  select_vars()

```
## Recatagorize county land use codes
In order to complete the vacant land and soft site analysis, we will need to break down properties into different classifications. This process creates three variables:

1. residential: 1 for residential, 0 for other
2. category: categories are sf, mf, commercial, office, and vacant.
3. category_detail: this will vary by jurisdiction, but  includes the most detail possible to generalize from the county land use codes.
4. building_type: this indicates the building type for multifamily parcels (condos and apartments)

Export county land use codes for manual classification
```{r export-landuse}
currentjur_county <- currentjur %>% 
  group_by(countylandusedescription) %>% 
  count()

if (!file.exists(paste0("../Data/", filepath, "-county-land-use.csv"))) {
  write_csv(currentjur_county,
            paste0("../Data/", filepath, "-county-land-use.csv"))
}

```

Note: Condos that have their own inidividual addresses are considered single-family. Once we determine which properties have unique addresses, the `category` and `category_detail` will be adjusted to "SF" and "SF attached" respectively. 

### Create categorization variables

We use `ifelse()` and `case_when()` to create the three new variables based on the county land use codes.

```{r classify}
res_codes <- 
  c("AFFORDABLE DWELLING UNIT",
    "APARTMENT - GARDEN",
    "APARTMENT - HIGH-RISE",
    "APARTMENT - MID-RISE",
    "APARTMENT - PARKING",
    "COMMUNITY BENEFIT UNIT",
    "MULTI-FAM IMPR/NO SITE PLAN",
    "MULTI-FAM IMPR/SITE PLAN",
    "MULTI-FAM VACANT/NO SITE PLAN",
    "MULTI-FAM VACANT/SITE PLAN",
    "NOT VALUED CONDO HOA",
    "NOT VALUED COSTED - HOA/SITE PLAN",
    "RESIDENTIAL COST-VAL - DUPLEX",
    "RESIDENTIAL COST-VAL - IMPR/SF & TW",
    "RESIDENTIAL COST-VAL - SIDE BY SIDE",
    "RESIDENTIAL COST-VAL - SINGLE-FAM DET",
    "RESIDENTIAL COST-VAL - TOWNHOUSE/CO",
    "RESIDENTIAL COST-VAL - TOWNHOUSE/FSO",
    "RESIDENTIAL COST-VAL - VAC/SF & TW",
    "SALES APPR CONDO/CO-OP",
    "SALES APPR CONDO/GARDEN",
    "SALES APPR CONDO/HIGH RISE",
    "SALES APPR CONDO/MID RISE",
    "SALES APPR CONDO/STACKED",
    "SFD - APT ZONED/NO SITE PLAN",
    "SFD - APT ZONED/SITE PLAN",
    "VACANT RESIDENTIAL")

currentjur_cat <- currentjur %>% 
  mutate(residential =
           ifelse(countylandusedescription %in% res_codes, 1, 0),
         category = case_when(
           countylandusedescription %in%
             c("COMMERCIAL CONDO",
               "GEN COMM-IND - AUTO DEALERSHIP",
               "GEN COMM-IND - SELF-STORAGE",
               "GEN COMM-IND - SERVICE STATION",
               "GEN COMM-IND - WAREHOUSE",
               "GEN COMM - BANK",
               "GEN COMM - FAST FOOD",
               "GEN COMM - HEALTH CARE FACILITY",
               "GEN COMM - MIXED OFFICE/COMM",
               "GEN COMM - NEIGHBORHOOD CTR",
               "GEN COMM - OTHER",
               "GEN COMM - REST/EATING FACILITY",
               "GEN COMM - RETAIL/STRIP",
               "GEN COMM - SMALL OFFICE",
               "GEN COMM IMPR-LAND/NO SITE PLAN",
               "GEN COMM IMPR-LAND/SITE PLAN",
               "GEN COMM/PARKING",
               "HOTEL - FULL SERVICE",
               "HOTEL - LAND/OTHER",
               "HOTEL - LIMITED SERVICE",
               "HOTEL - LODGING",
               "HOTEL - SELECT DRIVE",
               "HOTEL RESIDENCE SUITES",
               "MIXED USE",
               "SFD - COMM ZONED/NO SITE PLAN",
               "SFD - COMM ZONED/SITE PLAN") ~ "commercial",
           countylandusedescription %in%
             c("AFFORDABLE DWELLING UNIT",
               "APARTMENT - GARDEN",
               "APARTMENT - HIGH-RISE",
               "APARTMENT - MID-RISE",
               "APARTMENT - PARKING",
               "COMMUNITY BENEFIT UNIT",
               "MULTI-FAM IMPR/NO SITE PLAN",
               "MULTI-FAM IMPR/SITE PLAN",
               "NOT VALUED CONDO HOA",
               "RESIDENTIAL COST-VAL - DUPLEX",
               "SALES APPR CONDO/CO-OP",
               "SALES APPR CONDO/GARDEN",
               "SALES APPR CONDO/HIGH RISE",
               "SALES APPR CONDO/MID RISE",
               "SALES APPR CONDO/STACKED",
               "SFD - APT ZONED/NO SITE PLAN",
               "SFD - APT ZONED/SITE PLAN") ~ "mf",
           countylandusedescription %in%
             c("OFFICE BLDG IMPR-LAND/SITE PLAN",
               "OFFICE BLDG/7 OR MORE STORIES",
               "OFFICE BLDG/PARKING",
               "OFFICE BLDG/UNDER 7 STORIES") ~ "office",
           countylandusedescription %in%
             c("NOT VALUED COSTED - HOA/SITE PLAN",
               "RESIDENTIAL COST-VAL - IMPR/SF & TW",
               "RESIDENTIAL COST-VAL - SIDE BY SIDE",
               "RESIDENTIAL COST-VAL - SINGLE-FAM DET",
               "RESIDENTIAL COST-VAL - TOWNHOUSE/CO",
               "RESIDENTIAL COST-VAL - TOWNHOUSE/FSO") ~ "sf",
           countylandusedescription %in% 
             c("MULTI-FAM VACANT/NO SITE PLAN",
               "MULTI-FAM VACANT/SITE PLAN",
               "RESIDENTIAL COST-VAL - VAC/SF & TW",
               "VACANT RESIDENTIAL",
               "GEN COMM VAC-LAND/NO SITE PLAN",
               "GEN COMM VAC-LAND/SITE PLAN",
               "OFFICE BLDG VAC-LAND/NO SITE PLAN",
               "OFFICE BLDG VAC-LAND/SITE PLAN",
               "VACANT COMMERCIAL",
               "VACANT EXEMPT",
               "VACANT LIGHT INDUSTRIAL",
               "VACANT OFFICE") ~ "vacant"),
         category_detail = case_when(
           countylandusedescription %in%
             c("AFFORDABLE DWELLING UNIT",
               "APARTMENT - GARDEN",
               "APARTMENT - HIGH-RISE",
               "APARTMENT - MID-RISE",
               "APARTMENT - PARKING",
               "COMMUNITY BENEFIT UNIT",
               "MULTI-FAM IMPR/NO SITE PLAN",
               "MULTI-FAM IMPR/SITE PLAN",
               "SFD - APT ZONED/NO SITE PLAN",
               "SFD - APT ZONED/SITE PLAN") ~ "apartment",
           countylandusedescription %in% 
             c("COMMERCIAL CONDO",
               "GEN COMM-IND - AUTO DEALERSHIP",
               "GEN COMM-IND - SELF-STORAGE",
               "GEN COMM-IND - SERVICE STATION",
               "GEN COMM-IND - WAREHOUSE",
               "GEN COMM - BANK",
               "GEN COMM - FAST FOOD",
               "GEN COMM - HEALTH CARE FACILITY",
               "GEN COMM - MIXED OFFICE/COMM",
               "GEN COMM - NEIGHBORHOOD CTR",
               "GEN COMM - OTHER",
               "GEN COMM - REST/EATING FACILITY",
               "GEN COMM - RETAIL/STRIP",
               "GEN COMM - SMALL OFFICE",
               "GEN COMM IMPR-LAND/NO SITE PLAN",
               "GEN COMM IMPR-LAND/SITE PLAN",
               "GEN COMM/PARKING",
               "HOTEL - FULL SERVICE",
               "HOTEL - LAND/OTHER",
               "HOTEL - LIMITED SERVICE",
               "HOTEL - LODGING",
               "HOTEL - SELECT DRIVE",
               "HOTEL RESIDENCE SUITES",
               "MIXED USE",
               "SFD - COMM ZONED/NO SITE PLAN",
               "SFD - COMM ZONED/SITE PLAN") ~ "commercial",
           countylandusedescription %in% 
             c("NOT VALUED CONDO HOA",
               "SALES APPR CONDO/CO-OP",
               "SALES APPR CONDO/GARDEN",
               "SALES APPR CONDO/HIGH RISE",
               "SALES APPR CONDO/MID RISE",
               "SALES APPR CONDO/STACKED") ~ "condo",
           countylandusedescription %in% 
             c("RESIDENTIAL COST-VAL - DUPLEX") ~ "duplex",
           countylandusedescription %in%
             c("OFFICE BLDG IMPR-LAND/SITE PLAN",
               "OFFICE BLDG/7 OR MORE STORIES",
               "OFFICE BLDG/PARKING",
               "OFFICE BLDG/UNDER 7 STORIES") ~ "office",
           countylandusedescription %in%
             c("RESIDENTIAL COST-VAL - SIDE BY SIDE") ~ "sf attached",
           countylandusedescription %in% 
             c("NOT VALUED COSTED - HOA/SITE PLAN",
               "RESIDENTIAL COST-VAL - IMPR/SF & TW",
               "RESIDENTIAL COST-VAL - SINGLE-FAM DET") ~ "sf detached",
           countylandusedescription %in% 
             c("RESIDENTIAL COST-VAL - TOWNHOUSE/CO",
               "RESIDENTIAL COST-VAL - TOWNHOUSE/FSO") ~ "townhouse",
           countylandusedescription %in% 
             c("GEN COMM VAC-LAND/NO SITE PLAN",
               "GEN COMM VAC-LAND/SITE PLAN",
               "VACANT COMMERCIAL") ~ "vacant commercial",
           countylandusedescription %in% 
             c("VACANT EXEMPT") ~ "Vacant exempt",
           countylandusedescription %in% 
             c("VACANT LIGHT INDUSTRIAL") ~ "vacant light industrial",
           countylandusedescription %in%
             c("MULTI-FAM VACANT/NO SITE PLAN",
               "MULTI-FAM VACANT/SITE PLAN") ~ "vacant mf",
           countylandusedescription %in%
             c("OFFICE BLDG VAC-LAND/NO SITE PLAN",
               "OFFICE BLDG VAC-LAND/SITE PLAN",
               "VACANT OFFICE") ~ "vacant office",
           countylandusedescription %in%
             c("VACANT RESIDENTIAL") ~ "vacant residential",
           countylandusedescription %in%
             c("RESIDENTIAL COST-VAL - VAC/SF & TW") ~ "vacant sf"),
         building_type = case_when(
           countylandusedescription %in%
             c("APARTMENT - GARDEN",
               "SALES APPR CONDO/GARDEN") ~ "garden",
           countylandusedescription %in%
             c("APARTMENT - HIGH-RISE",
               "SALES APPR CONDO/HIGH RISE") ~ "high-rise",
           countylandusedescription %in%
             c("SALES APPR CONDO/MID RISE",
               "APARTMENT - MID-RISE") ~ "mid-rise",
           countylandusedescription %in%
             c("APARTMENT - PARKING") ~ "parking",
           countylandusedescription %in%
             c("SALES APPR CONDO/STACKED") ~ "stacked",
           countylandusedescription %in%
             c("SALES APPR CONDO/CO-OP") ~ "co-op",
           countylandusedescription %in%
             c("RESIDENTIAL COST-VAL - DUPLEX") ~ "duplex",
           countylandusedescription %in%
             c("AFFORDABLE DWELLING UNIT",
               "COMMUNITY BENEFIT UNIT",
               "MULTI-FAM IMPR/NO SITE PLAN",
               "MULTI-FAM IMPR/SITE PLAN",
               "NOT VALUED CONDO HOA",
               "SFD - APT ZONED/NO SITE PLAN",
               "SFD - APT ZONED/SITE PLAN") ~ "other")
         )
```

### Check variable classifications
These checks make sure that all county land use codes recieved new classifications, and shows the distribution of properties 

#### {.tabset .tabset.fade}
##### residential
```{r res-check}
count(currentjur_cat, residential)
count(currentjur_cat, is.na(residential))
```

##### category
```{r cat-check}
count(currentjur_cat, category)
count(currentjur_cat, is.na(category))
```
##### category_detail
```{r catd-check}
count(currentjur_cat, category_detail)
count(currentjur_cat, is.na(category_detail))
```
##### building_type
Here, we expect NAs since `building_type` is only for MF properties- but we should have the same number of non-missing values as we do MF observations
```{r bt-check}
sum(!is.na(currentjur_cat$building_type))
nrow(filter(currentjur_cat, category == "mf"))
```

### Recreate lot size
There are errors in the different Black Knight lot size variables that make it impossible to compare lot size when reported in acres and square feet. Here, we create two new variables, `lotsize_acres` and `lotsize_sf` that standardize the unit of measurement. These variables will also convert values of 0 to `NA`, which will simplify calculations down the line.
```{r count}
count(currentjur_cat, lotsizeareaunit)
```

```{r lot}
currentjur_cat <- currentjur_cat %>% 
  mutate(lotsize_acres = case_when(lotsizeareaunit == "AC" ~ lotsizeorarea ,
                                   lotsizeareaunit == "SF" ~ lotsizeorarea / 43560),
         lotsize_sf = lotsize_acres * 43560) %>% 
  mutate_at(vars(lotsize_acres, lotsize_sf), ~ replace(., .==0, NA))

```

## Collapsing properties
Next, we have to ensure that there is only one observation per address in the dataset. 

### Preserving parcel numbers
Parcels that have the same address do not share the same parcel ID, but they do share the same first five digits. We can clean up the parcel ID and preserve the first 5 digits in case there is a need to later combine with another parcel-level dataset.

```{r parcel}
currentjur_cat <- currentjur_cat %>% 
  mutate(parcel_address = substr(assessorsparcelnumberapnpin, 1, 6))

```

We can do a quick check to make sure that there are no properties that have the same address but different parcel IDs by seeing if the number of rows are the same when we group by address and parcel ID, vs. just grouping by address.

```{r check-parcel}
currentjur_cat %>% 
  filter(residential == 1) %>% 
  group_by(propaddress) %>% 
  count() %>% 
  nrow()

currentjur_cat %>% 
  filter(residential == 1) %>% 
  group_by(propaddress, parcel_address) %>% 
  count() %>% 
  nrow()

```

### House number cleaning 
There are a number of properties that have numbers or symbols in their house numbers that prevent a collapse. This next step removes those characters so the collapse is clean.
This will also recategorize properties that have a missing house number as properties that have a missing address. This is important for the collapse because it could cause us to combine two observations that would otherwise be seperate.

```{r letters}
currentjur_cat2 <- currentjur_cat %>% 
  mutate(house_letter = ifelse(str_detect(prophouseno, "[:alpha:]") == 1, 1, 0),
         oldadd = propaddress,
         new_houseno = ifelse(house_letter == 1,
                              str_replace(prophouseno, "[:alpha:]", ""), prophouseno),
         propaddress = ifelse(house_letter == 1, 
                              paste(str_replace_all(new_houseno, "-", ""),
                                    propstreetname, 
                                    propstreetsuffix,
                                    sep = " "),
                              propaddress))
```

 Compare the first 20 addresses to check
```{r letters-check}
currentjur_cat2 %>% 
  filter(house_letter == 1) %>% 
  select(oldadd, propaddress) %>% 
  head(20)

```

After this change, the number of NAs in the address variable should be the same as the number of observations that previously had either a missing address, missing house number, or both.
```{r letters-check2}
sum(is.na(currentjur_cat2$propaddress))
nrow(filter(currentjur_cat, 
            is.na(propaddress) | is.na(prophouseno)))
```

### Address break out
In order to do the collapse, we first identify addresses with more than one observation, and filter out those with a missing house number or address to avoid an improper collapse. Then, run a quick check to make sure all the records are still accounted for.

```{r sep}
singles <- get_single_properties(currentjur_cat2)
multiples <- get_multiple_properties(currentjur_cat2)
missing_address <- get_missing_address(currentjur_cat2)
check_classification(currentjur_cat2)
```

For addresses that have some records with missing zoning, but others that have a zoning designation: we need to fill the NAs with the appropriate zoning code. `group_by()` means that zoning codes will not be passed on to observations with a different address, and using `fill()` in both directions means that the NAs will be filled regardless of their position.

### Multiple addresses
```{r fill}
multiples <- multiples %>% 
  group_by(propaddress) %>% 
  fill(zoning) %>% 
  fill(zoning, .direction = "up") %>% 
  ungroup()
```

Next, we summarize the data using nested lists, which allow us to preserve all the details from each record and apply the right function to each. The table below describes each variable, which function to use, and what to do in the case of a tie. Lot size is a unique case, detail provided in the next section.

```{r var-table, echo=FALSE, results = 'asis', eval=TRUE}

v <- tibble::tibble(variable = c("zoning", 
                         "lotsizeorarea", 
                         "lotsizesquarefeet",
                         "buildingarea", 
                         "countylandusedescription",
                         "residential", 
                         "category", 
                         "category_detail",
                         "yearbuilt", 
                         "long", 
                         "lat"),
            operation = c("mode", 
                          "conditional based on values",
                          "conditional based on values",
                          "sum",
                          "mode",
                          "max",
                          "mode",
                          "mode",
                          "max",
                          "median",
                          "median"),
            `in case of tie` = c("take most dense zoning code (?)",
                                 "",
                                 "",
                                 "",
                                 "case-by-case basis",
                                 "residential",
                                 "case-by-case basis",
                                 "case-by-case basis",
                                 "take maxiumum year- accounts for renovation",
                                 "median longitude and latitude ensures this is a correct pairing, falls within the address",
                                 "median longitude and latitude ensures this is a correct pairing, falls within the address"))

knitr::kable(v)

```


``` {r nest}
nested <- multiples %>% 
  group_by(propaddress) %>%
  summarise_at(vars(zoning, lotsizeorarea, lotsizesquarefeet,
                    buildingarea, countylandusedescription,
                    residential, category, category_detail,
                    yearbuilt, long, lat), list) %>% 
  rename_at(vars(-propaddress), ~ paste0(., "_list")) %>% 
  mutate(nprops = map(zoning_list, length),
         zoning = map(zoning_list, Mode),
         lotsizeorarea = map(lotsizeorarea_list, sum),
         lotsizesquarefeet = map(lotsizesquarefeet_list, sum),
         buildingarea = map(buildingarea_list, sum),
         countylandusedescription = map(countylandusedescription_list, Mode),
         residential = map(residential_list, max),
         category = map(category_list, Mode),
         category_detail = map(category_detail_list, Mode),
         yearbuilt = map(yearbuilt_list, max),
         long = map(long_list, median),
         lat = map(lat_list, median))
```

#### Lot size

Lot size cannot be summarized with one operation, because it is reported differently for different buildings. The following examples show three cases that we attempt to solve for with the `get_lot_size()` function

``` {r lot-ex, echo=FALSE}
weird <- tibble(propaddress = c( "1330 S FAIR ST", "1633 N COLONIAL TER", "1117 N VERMONT ST", "1134 N STUART ST", "1300 N MEADE ST"),
                instance = 1:5)

weird1 <- nested %>% 
  filter(propaddress %in% weird$propaddress) %>%
  left_join(weird, by = "propaddress") %>% 
  select(instance, propaddress, nprops, lotsizesquarefeet_list, lotsizesquarefeet) %>% 
  arrange(instance)

knitr::kable(weird1)

```

- In the first instance, the lot size is repeated- the number of unique lot sizes is 1, so mode is the right function.
- In the second instance, the sum of the lot size is the incorrect lot size, and the mode is a better function- but there is more than one unique value.
- In the third example, the mode would give is a lot size of 0, which is also incorrect- but again, every value is not unique. 
- In the fourth instance, there are the same number of unique values as there are properties- sum is the correct function. 
- In the fifth instance, we need to replace the lot size of 0 with `NA`, so future operations will also return `NA`. 

We can use the difference between the number of unique elements in the `lotsizesquarefeet_list` vector to determine which operation to use. 

``` {r lot-fun}
get_lot_size <- function(dataset = nested) {
  
  newvars <- nested %>% 
    select(propaddress, nprops, lotsizesquarefeet_list, 
           buildingarea_list, buildingarea) %>% 
    mutate(nprops = as.integer(nprops),
           unqlotsize = as.integer(map(lotsizesquarefeet_list, 
                            function(x) length(unique(x)))),
           unqbuildingarea = map(buildingarea_list, 
                            function(x) length(unique(x))),
           lot_mode = map(lotsizesquarefeet_list, Mode),
           lot_sum = as.integer(map(lotsizesquarefeet_list, sum)),
           ba_mode = map(buildingarea_list, Mode),
           ba_sum = map(buildingarea_list, sum),
           lot_alwayssum = ifelse(unqlotsize == nprops, 1, 0),
           ba_alwayssum = ifelse(unqbuildingarea == nprops, 1, 0))
    
}

```


#### Ties

There are 62 instances where there is a tie in the zoning code- examples below.
``` {r ties}
ties <- nested %>% 
  mutate(ties_z = ifelse(map(zoning, length) > 1, 1, 0)) %>% 
  filter(ties_z == 1) %>% 
  mutate(z1 = map(zoning, function(x) x[1]),
         z2 = map(zoning, function(x) x[2]),
         z3 = map(zoning, function(x) x[3]),
         cl1 = map(countylandusedescription, function(x) x[1]),
         cl2 = map(countylandusedescription, function(x) x[2]),
         cl3 = map(countylandusedescription, function(x) x[3])) %>% 
  select(propaddress, nprops,
         z1, z2, z3,
         cl1, cl2, cl3) %>% 
  unnest()

ties %>%
  select(propaddress, z1, z2) %>% 
  head(5)
```
These will likely have to be figured out manually. Write out the file to determine how to break the ties.

``` {r write-ties}
if (!file.exists(paste0("../Data/", filepath, "-zoning-ties.csv"))) { 
    write_csv(ties,
          paste0("../Data/", filepath, "-zoning-ties.csv"))
  } else {
  warning("ties file already exists")
}

```

### Single addresses

For single addresses, we have to reclassify condos that have a unique observation as single-family structures, since condos are listed seperately for each unit

```{r singles-count}
count(singles, category_detail)

singles <- singles %>% 
  mutate(category = ifelse(category_detail == "condo",
                           "sf",
                           category),
         category_detail = ifelse(category_detail == "condo",
                                  "sf attached",
                                  category_detail))
```

## Recombine and save data

```{r combine}

```
