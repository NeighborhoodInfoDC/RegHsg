---
title: "Regional Housing Framework"
subtitle: "Upzoning analysis for Arlington County"
author: ""
output:
  html_document:
    number_sections: FALSE
    self_contained: TRUE
    code_folding: show
    toc: TRUE
    toc_float: TRUE
    css: ../www/web_report.css
    editor_options:
      chunk_output_type: console
---

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato" />

Library: RegHsg

Project: Regional Housing Framework

Author: Sarah Strochak

Version: R 3.5.1, RStudio 1.1.423

Last updated `r format(Sys.time(), '%B %d, %Y')`

Environment: Local Windows session (desktop)


```{r rmarkdown-setup, echo = FALSE}
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
# knitr::opts_chunk$set(eval = FALSE)
```

## Description

The goal of this analysis is to estimate the number of units to be gained from upzoning the existing housing stock within 1 mile of COG activity centers and 1/2 mile of rail, including MARC/VRE.

The metric that we use for density will be defined as units per acre. 

## Set-up
Load libraries and functions
```{r setup}
library(tidyverse)
library(sf)
library(urbnthemes)
library(units)

source("../Macros/read-arlington.R")
source("../Macros/get_node_geography.R")

```

Create directory for data exports
```{r dir}
if (!dir.exists("../Data")) {
  dir.create("../Data")
}

```


Set FIPS code, filepath name, and directory for maps

```{r fips}
currentfips <- "51013"
filepath <- "arlington"
rhfdir <- "L:/Libraries/RegHsg/Maps"
```

Load in  cleaned Arlington data. Fill in lot size where possible, as done in vacant lots analysis.

```{r read}
if (!exists("jur")) {
  jur <- read_arlington(filepath)
} else {
  warning(filepath, " data already read in")
}


jur <- jur %>% 
  mutate(arc_lotsize_sf = lotsize_sf, # archive the original lot size variable
         lotsize_sf = ifelse(is.na(lotsize_sf),
                             parcel_area,
                             lotsize_sf),
         lotsize_sf = ifelse(is.na(lotsize_sf),
                             lotsize_prop,
                             lotsize_sf),
         lotsize_acres = lotsize_sf / 43560)

```


Use the functions established in `clean-node-geographies.Rmd` to read in shapefiles for nodes. Start with activity centers.

```{r get-nodes}

act1mile <- get_node_geography(node_type = "activity",
                               style = "buffer",
                               activity_buffer = 1)

```

Read in Arlington zoning layer


```{r read-zon}

zon <- st_read(dsn = paste0(rhfdir, "/",
                            filepath, "-zoning-map"),
               layer = "Zoning_Polygons") %>% 
  st_transform(crs = 4326)


```

Convert Black Knight data to spatial.

```{r bk-spatial}

jursf <- jur %>% 
  filter(!(is.na(lat) | is.na(long))) %>% 
  st_as_sf(coords = c("long", "lat")) %>% 
  st_set_crs(st_crs(zon))
  

```
\
## Example

Pick one activity center in Arlington to test and visualize the calculation. Use Clarendon activity center as an example.

```{r clar}

clarendon <- filter(act1mile, name == "Clarendon")

ggplot() +
  geom_sf(zon, mapping = aes(fill = GZDC)) +
  scale_fill_manual(values = c("#1696d2", "#ec008b", "#d2d2d2",
                               "#fdbf11", "#55b748", "#0a4c6a")) +
  geom_sf(clarendon, mapping = aes(),
          fill = NA, size = 1.6, color = "black") +
  theme_urbn_map() +
  coord_sf(datum = NA)

```

We can clip the zoning layer and the Black Knight data to the circumference of the buffer.

```{r clip-zon}

zon_clar <- st_intersection(zon, clarendon)
bk_clar <- st_intersection(jursf, clarendon)

ggplot() +
  geom_sf(zon_clar, mapping = aes(fill = GZDC)) +
  scale_fill_manual(values = c("#1696d2", "#ec008b", "#d2d2d2",
                               "#fdbf11", "#55b748", "#0a4c6a")) +
  theme_urbn_map() +
  coord_sf(datum = NA)

ggplot() +
  geom_sf(zon_clar, mapping = aes()) +
  geom_sf(bk_clar, mapping = aes()) +
  theme_urbn_map() +
  coord_sf(datum = NA)

```

### Test zoning and land use within activity zone

Test how much of the area in the buffered zone is in each zoning code.

```{r calc-area}

zon_clar <- zon_clar %>% 
  mutate(area = st_area(zon_clar) %>% set_units("acre"))

totalarea <- sum(zon_clar$area)
units(totalarea) <- NULL
units(zon_clar$area) <- NULL

zon_clar %>% as.data.frame() %>% 
  group_by(ZN_DESIG) %>% 
  summarize(area= sum(area)) %>% 
  mutate(p_area = (area/totalarea) %>% 
                   set_units(NULL)) %>% 
  arrange(desc(p_area)) %>%
  mutate(area_sum = cumsum(p_area)) %>% 
  knitr::kable()

```

Use lot size to test land use inside zone.

```{r land-use}

total_area_parcel <- bk_clar %>% 
  as.data.frame() %>% 
  summarize(sum(lotsize_acres, na.rm = TRUE)) %>% 
  pull()

bk_clar %>% 
  as.data.frame() %>% 
  group_by(category_detail) %>% 
  summarize(area = sum(lotsize_acres, na.rm = TRUE),
            p_area = area / total_area_parcel) %>% 
  arrange(desc(p_area)) %>% 
  mutate(area_sum = cumsum(p_area))

```


### Develop metric for density

Calculate units per acre- only include residential properties.

```{r units-per-acre}

bk_clar <- bk_clar %>% 
  mutate(numberofunits = ifelse(category == "sf" & numberofunits == 0,
                                1,
                                numberofunits))

total_acres_residential <- bk_clar %>% 
  as.data.frame() %>% 
  filter(residential == 1) %>% 
  summarize(sum(lotsize_acres, na.rm = TRUE)) %>% 
  pull()


total_units <- bk_clar %>% 
  as.data.frame() %>% 
  filter(residential == 1) %>% 
  summarize(sum(numberofunits, na.rm = TRUE)) %>% 
  pull()
  
total_units / total_acres_residential

```

Calculate density for each zoning code.

```{r density-zoning}

bk_clar %>% 
  as.data.frame() %>% 
  group_by(zoning) %>% 
  summarize(total_units = sum(numberofunits, na.rm = TRUE),
            total_acres_residential = sum(lotsize_acres, na.rm = TRUE)) %>% 
  mutate(units_per_acre = total_units / total_acres_residential) %>% 
  arrange(desc(total_acres_residential)) %>% 
  head(20) %>% 
  knitr::kable()


```


## Application

QUESTION- how to deal with activity zones that overlap jurisdictions??

