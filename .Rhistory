"building_type",
"yearbuilt",
"long",
"lat"),
operation = c("mode",
"conditional based on values",
"sum",
"mode",
"max",
"mode",
"mode",
"mode",
"max",
"median",
"median"),
`in case of tie` = c("take most dense zoning code (?)",
"",
"",
"case-by-case basis",
"residential",
"case-by-case basis",
"case-by-case basis",
"case-by-case basis",
"take maxiumum year- accounts for renovation",
"median longitude and latitude ensures this is a correct pairing, falls within the address",
"median longitude and latitude ensures this is a correct pairing, falls within the address"))
knitr::kable(v)
rm(v)
``` {r nest}
v <- tibble::tibble(variable = c("zoning",
"lotsize_sf",
"buildingarea",
"countylandusedescription",
"residential",
"category",
"category_detail",
"building_type",
"yearbuilt",
"long",
"lat"),
operation = c("mode",
"conditional based on values",
"sum",
"mode",
"max",
"mode",
"mode",
"mode",
"max",
"median",
"median"),
`in case of tie` = c("take most dense zoning code (?)",
"",
"",
"case-by-case basis",
"residential",
"case-by-case basis",
"case-by-case basis",
"case-by-case basis",
"take maxiumum year- accounts for renovation",
"median longitude and latitude ensures this is a correct pairing, falls within the address",
"median longitude and latitude ensures this is a correct pairing, falls within the address"))
knitr::kable(v)
rm(v)
``` {r nest}
View(nested)
library(tidyverse)
library(DescTools)
library(purrr)
source("../Macros/read-bk.R")
source("../Macros/filter-bk.R")
source("../Macros/select-vars.R")
source("../Macros/sample-properties.R")
source("../Macros/classify-addresses.R")
nested <- multiples %>%
group_by(propaddress, parcel_address) %>%
summarize_at(vars(zoning,lotsize_sf,
buildingarea, countylandusedescription,
residential, category, category_detail, building_type,
yearbuilt, long, lat), list) %>%
rename_at(vars(-propaddress, -parcel_address), ~ paste0(., "_list")) %>%
mutate(nprops = map(zoning_list, length),
zoning = map(zoning_list, Mode),
lotsize_sf_sum = map_dbl(lotsize_sf_list, sum, na.rm = TRUE),
buildingarea = map_dbl(buildingarea_list, sum, na.rm = TRUE),
countylandusedescription = map(countylandusedescription_list, Mode),
residential = map(residential_list, max, na.rm = FALSE),
category = map(category_list, Mode),
category_detail = map(category_detail_list, Mode),
building_type = ifelse(category == "MF",
map(building_type_list, Mode),
NA),
long = map(long_list, median),
lat = map(lat_list, median),
# year built handled differently due to missing values
yearbuilt_list = ifelse(as.integer(map(yearbuilt_list, function(x) sum(!is.na(x)))) == 0,
NA,
yearbuilt_list),
yearbuilt = ifelse(!is.na(yearbuilt_list),
map(yearbuilt_list, max, na.rm = TRUE),
NA))
multiples <- jur %>%
filter(address_type == "multiple")
jur <- jur %>%
mutate(address_type = ifelse(category_detail %in% c("townhouse", "sf attached"),
"single",
address_type))
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
# knitr::opts_chunk$set(eval = FALSE)
library(tidyverse)
library(DescTools)
library(purrr)
source("../Macros/read-bk.R")
source("../Macros/filter-bk.R")
source("../Macros/select-vars.R")
source("../Macros/sample-properties.R")
source("../Macros/classify-addresses.R")
if (!dir.exists("Data")) {
dir.create("Data")
}
currentfips <- "51107"
filepath <- "loudoun"
if (!exists("region")) {
region <- read_bk("dc-cog-assessment_20181228.csv")
} else {
warning("region data already read in")
}
jur <- region %>%
filter_bk(fips = currentfips) %>%
select_vars()
currentjur_county <- jur %>%
group_by(countylandusedescription) %>%
count()
if (!file.exists(paste0("../Data/", filepath, "-county-land-use.csv"))) {
write_csv(currentjur_county,
paste0("../Data/", filepath, "-county-land-use.csv"))
}
rm(currentjur_county)
res_codes <-
c("CONDOMINIUM (RESIDENTIAL)",
"DUPLEX",
"MOBILE/MANUFACTURED HOMES",
"MULTI-FAMILY",
"MULTI-FAMILY - VACANT",
"MULTIPLE OCCUPANCIES",
"RES CONDO GARAGE UNIT",
"RESIDENTIAL CONDOS",
"RURAL RESIDENCE (AGRICULTURAL)",
"RURAL RESIDENCE AGRICULTURAL",
"SINGLE FAMILY",
"SINGLE FAMILY - VACANT",
"TOWN HOUSES",
"TOWNHOUSES - VACANT",
"TRAILER PARK",
"TRAILER PARK - VACANT")
jur <- jur %>%
mutate(residential =
ifelse(countylandusedescription %in% res_codes, 1, 0))
rm(res_codes)
other <- c("AUTO SALES",
"AUTOMOTIVE BUILDINGS",
"BANK",
"CEMETERY",
"CHURCH",
"COMMERCIAL",
"COMMERCIAL CONDO'S",
"COMMERCIAL CONDOS",
"CONDO-FLEX WAREHOUSE",
"CONDO-WAREHOUSE",
"DATA CENTER",
"EDUCATIONAL",
"FARM > 20 ACRES",
"FAST FOOD RESTAURANT",
"FIRE DEPT",
"FLEX WAREHOUSE",
"GAS AND GO",
"GOVERNMENT PROPERTY",
"GOVT PROP",
"GROCERY STORE",
"HANGER",
"HOTEL LUXURY",
"IMPROVED, USE NOT SPECIFIED",
"LEASEHOLD RIGHTS (MISC)",
"LIGHT INDUSTRIAL",
"MEDICAL BUILDING",
"MEDIUM/HEAVY INDUST",
"MINI WAREHOUSE",
"MISC COMM STRUCTURE",
"MISC COMMERCIAL STRUCTURE",
"MISC IMPROVEMENTS",
"MISCELLANEOUS (GENERAL)",
"MOTEL/HOTEL",
"OFFICE BUILDING",
"OFFICE/RETAIL",
"RECREATIONAL",
"RESTAURANT",
"RETAIL STORE",
"SHOPPING CENTER",
"WAREHOUSE",
"WINERY")
mf <- c("DUPLEX",
"MULTI-FAMILY",
"MULTIPLE OCCUPANCIES",
"RESIDENTIAL CONDOS",
"CONDOMINIUM (RESIDENTIAL)",
"RES CONDO GARAGE UNIT")
sf <- c("RURAL RESIDENCE (AGRICULTURAL)",
"RURAL RESIDENCE AGRICULTURAL",
"SINGLE FAMILY",
"MOBILE/MANUFACTURED HOMES",
"TOWN HOUSES",
"TRAILER PARK")
vacant <- c("AUTOMOTIVE BUILDINGS - VACANT",
"COMMERCIAL CONDOS - VACANT",
"FLEX WAREHOUSE - VACANT",
"GROCERY STORE - VACANT",
"MINI WAREHOUSE - VACANT",
"MISC COMM STRUCTURE - VACANT",
"MISC COMMERCIAL STRUCTURE - VACANT",
"MISC IMPROVEMENTS - VACANT",
"MULTI-FAMILY - VACANT",
"OFFICE BUILDING - VACANT",
"RECREATIONAL - VACANT",
"RETAIL STORE - VACANT",
"SHOPPING CENTER - VACANT",
"SINGLE FAMILY - VACANT",
"TOWNHOUSES - VACANT",
"TRAILER PARK - VACANT",
"VACANT LAND",
"WAREHOUSE - VACANT",
"WINERY - VACANT")
missing <- c("NA")
jur <- jur %>%
mutate(category = case_when(
countylandusedescription %in% other ~ "other",
countylandusedescription %in% mf ~ "mf",
countylandusedescription %in% sf ~ "sf",
countylandusedescription %in% vacant ~ "vacant",
is.na(countylandusedescription) ~ "missing"))
rm(other, mf, sf, vacant, missing)
apartment <- c("MULTI-FAMILY",
"MULTIPLE OCCUPANCIES")
commercial <- c("AUTO SALES",
"AUTOMOTIVE BUILDINGS",
"BANK",
"CEMETERY",
"CHURCH",
"COMMERCIAL",
"COMMERCIAL CONDO'S",
"COMMERCIAL CONDOS",
"CONDO-FLEX WAREHOUSE",
"CONDO-WAREHOUSE",
"DATA CENTER",
"FARM > 20 ACRES",
"FAST FOOD RESTAURANT",
"FLEX WAREHOUSE",
"GAS AND GO",
"GROCERY STORE",
"HOTEL LUXURY",
"LIGHT INDUSTRIAL",
"MEDICAL BUILDING",
"MEDIUM/HEAVY INDUST",
"MINI WAREHOUSE",
"MISC COMM STRUCTURE",
"MISC COMMERCIAL STRUCTURE",
"MOTEL/HOTEL",
"RESTAURANT",
"RETAIL STORE",
"SHOPPING CENTER",
"WAREHOUSE",
"WINERY")
condo <- c("RESIDENTIAL CONDOS",
"CONDOMINIUM (RESIDENTIAL)",
"RES CONDO GARAGE UNIT")
duplex <- c("DUPLEX")
office <- c("OFFICE BUILDING",
"OFFICE/RETAIL")
mfattached <- c("MULTI-FAMILY",
"MULTIPLE OCCUPANCIES")
sfdetached <- c("SINGLE FAMILY",
"RURAL RESIDENCE (AGRICULTURAL)",
"RURAL RESIDENCE AGRICULTURAL")
trailer <- c("MOBILE/MANUFACTURED HOMES",
"TRAILER PARK")
townhouse <-  c("TOWN HOUSES")
educational <- c("EDUCATIONAL")
firedepartment <- c("FIRE DEPT")
recreational <- c("RECREATIONAL")
govt <- c("GOVERNMENT PROPERTY",
"GOVT PROP")
otheruse <- c("HANGER",
"IMPROVED, USED NOT SPECIFIED",
"LEASEHOLD RIGHTS (MISC)",
"MISC IMPROVEMENTS",
"MISCELLANEOUS (GENERAL)")
vacantcom <- c("AUTOMOTIVE BUILDINGS - VACANT",
"COMMERCIAL CONDOS - VACANT",
"FLEX WAREHOUSE - VACANT",
"GROCERY STORE - VACANT",
"MINI WAREHOUSE - VACANT",
"MISC COMM STRUCTURE - VACANT",
"MISC COMMERCIAL STRUCTURE - VACANT",
"OFFICE BUILDING - VACANT",
"RETAIL STORE - VACANT",
"SHOPPING CENTER - VACANT",
"WAREHOUSE - VACANT",
"WINERY - VACANT")
vacantother <- c("VACANT LAND",
"MISC IMPROVEMENTS - VACANT",
"RECREATIONAL - VACANT")
vacantmf <- c("MULTI-FAMILY VACANT")
vacantoffice <- c("OFFICE BUILDING - VACANT")
vacantsf <- c("SINGLE FAMILY - VACANT")
vacanttownhouse <- ("TOWNHOUSES - VACANT")
vacanttrailer <- ("TRAILER PARK - VACANT")
missingdetail <- c("NA")
jur <- jur %>%
mutate(category_detail = case_when(
countylandusedescription %in% apartment ~ "apartment",
countylandusedescription %in% commercial ~ "commercial",
countylandusedescription %in% condo ~ "condo",
countylandusedescription %in% duplex ~ "duplex",
countylandusedescription %in% office ~ "office",
countylandusedescription %in% mfattached ~
"mf attached",
countylandusedescription %in% sfdetached ~ "sf detached",
countylandusedescription %in% trailer ~
"trailer",
countylandusedescription %in% townhouse ~ "townhouse",
countylandusedescription %in% educational ~
"educational",
countylandusedescription %in% firedepartment ~
"fire department",
countylandusedescription %in% recreational ~
"recreational",
countylandusedescription %in% govt ~
"government",
countylandusedescription %in% otheruse ~
"other use",
countylandusedescription %in% vacantcom ~ "vacant commercial",
countylandusedescription %in% vacantother ~ "vacant other",
countylandusedescription %in% vacantmf ~ "vacant mf",
countylandusedescription %in% vacantoffice ~ "vacant office",
countylandusedescription %in% vacantsf ~ "vacant sf",
countylandusedescription %in% vacanttownhouse ~
"vacant townhouse",
countylandusedescription %in% vacanttrailer ~
"vacant trailer",
is.na(countylandusedescription) ~ "missingdetail"))
rm(apartment, commercial, condo, duplex,
office, mfattached, sfdetached, trailer, townhouse,
educational, firedepartment, recreational, govt, otheruse, vacantcom, vacantother, vacantmf,
vacantoffice, vacantsf, vacanttownhouse, vacanttrailer, missingdetail)
jur <- jur %>%
mutate(building_type = "")
count(jur, residential)
count(jur, is.na(residential))
if (TRUE %in% is.na(jur$residential)) {
warning("NAs introduced")
}
count(jur, category)
count(jur, is.na(category))
if (TRUE %in% is.na(jur$category)) {
warning("NAs introduced")
}
count(jur, category_detail)
count(jur, is.na(category_detail))
if (TRUE %in% is.na(jur$category_detail)) {
warning("NAs introduced")
}
newcat <- sum(!is.na(jur$building_type))
mf <- nrow(filter(jur, category == "mf"))
if (mf != newcat) {
warning(newcat, " observations categorized, expecting ", mf)
}
rm(newcat, mf)
count(jur, lotsizeareaunit)
jur <- jur %>%
mutate(lotsize_acres = case_when(lotsizeareaunit == "AC" ~ lotsizeorarea ,
lotsizeareaunit == "SF" ~ lotsizeorarea / 43560),
lotsize_sf = lotsize_acres * 43560) %>%
mutate_at(vars(lotsize_acres, lotsize_sf), ~ replace(., .==0, NA))
jur <- jur %>%
mutate(parcel_address = substr(assessorsparcelnumberapnpin, 1, 6))
bad_parcels <- jur %>%
group_by(propaddress) %>%
summarize(parcel = list(parcel_address)) %>%
mutate(unq_parcels = as.integer(map(parcel,
function(x) length(unique(x))))) %>%
filter(unq_parcels > 1)
bad_addresses <- bad_parcels %>%
pull(propaddress)
jur <- jur %>%
mutate(parcel_address = ifelse(propaddress %in% bad_addresses,
NA,
parcel_address))
rm(bad_addresses, bad_parcels)
x <- jur %>%
filter(residential == 1) %>%
group_by(propaddress) %>%
count() %>%
nrow()
y <- jur %>%
filter(residential == 1) %>%
group_by(propaddress, parcel_address) %>%
count() %>%
nrow()
if (x == y) {
print(paste0(x, " = ", y, ": clean collapse"))
} else if (y > x) {
warning("additional observations introduced")
}
rm(x, y)
jur <- jur %>%
mutate(house_letter = ifelse(str_detect(prophouseno, "[:alpha:]") == 1, 1, 0),
oldadd = propaddress,
new_houseno = ifelse(house_letter == 1,
str_replace(prophouseno, "[:alpha:]", ""),
prophouseno),
propaddress = ifelse(house_letter == 1,
paste(str_replace_all(new_houseno, "-", ""),
propstreetname,
propstreetsuffix,
sep = " "),
propaddress))
jur %>%
filter(house_letter == 1) %>%
select(oldadd, propaddress, category_detail) %>%
head(20)
stopifnot(sum(is.na(jur$propaddress)) == nrow(filter(jur,
is.na(propaddress) | is.na(prophouseno))))
jur <- jur %>%
classify_addresses()
count(jur, address_type)
if (TRUE %in% is.na(jur$address_type)) {
warning("NAs in address_type")
}
jur <- jur %>%
mutate(address_type = ifelse(category_detail %in% c("townhouse", "sf attached"),
"single",
address_type))
multiples <- jur %>%
filter(address_type == "multiple")
singles <- jur %>%
filter(address_type == "single")
missing <- jur %>%
filter(address_type == "missing")
multiples <- multiples %>%
group_by(propaddress) %>%
fill(zoning) %>%
fill(zoning, .direction = "up") %>%
ungroup()
nested <- multiples %>%
group_by(propaddress, parcel_address) %>%
summarize_at(vars(zoning, lotsize_sf,
buildingarea, countylandusedescription,
residential, category, category_detail, building_type,
yearbuilt, long, lat), list) %>%
rename_at(vars(-propaddress, -parcel_address), ~ paste0(., "_list")) %>%
mutate(nprops = map(zoning_list, length),
zoning = map(zoning_list, Mode),
lotsize_sf_sum = map_dbl(lotsize_sf_list, sum, na.rm = TRUE),
buildingarea = map_dbl(buildingarea_list, sum, na.rm = TRUE),
countylandusedescription = map(countylandusedescription_list, Mode),
residential = map(residential_list, max, na.rm = FALSE),
category = map(category_list, Mode),
category_detail = map(category_detail_list, Mode),
building_type = ifelse(category == "MF",
map(building_type_list, Mode),
NA),
long = map(long_list, median),
lat = map(lat_list, median),
# year built handled differently due to missing values
yearbuilt_list = ifelse(as.integer(map(yearbuilt_list, function(x) sum(!is.na(x)))) == 0,
NA,
yearbuilt_list),
yearbuilt = ifelse(!is.na(yearbuilt_list),
map(yearbuilt_list, max, na.rm = TRUE),
NA))
nested <- nested %>%
mutate(nprops = as.integer(nprops),
lotsiz_sf_sum = as.integer(lotsize_sf_sum),
unique_lots = map(lotsize_sf_list, function(x) length(unique(x))),
lsfirst = map(lotsize_sf_list, function(x) x[1]),
lsmode = ifelse(lotsize_sf_sum == 0,
NA,
map(lotsize_sf_list, Mode, na.rm = TRUE))
) %>%
ungroup()
nested <- nested %>%
mutate(fxn = case_when(
lotsize_sf_sum < 1 ~ "missing",
nprops == unique_lots ~ "sum",
unique_lots == 1 ~ "first",
TRUE ~ "other"
))
nested %>% count(fxn)
nested_done <- nested %>%
filter(fxn != "other")
nested_other <- nested %>%
filter(fxn == "other") %>%
mutate(lsmode_num = ifelse(map(lsmode, length) > 1, NA, lsmode),
lsmode_num = as.integer(lsmode_num),
fxn = case_when(
nprops > 500 ~ "missing",
lsmode_num > 8000 ~ "mode",
TRUE ~ "sum"
))
nested_other <- nested %>%
filter(fxn == "other")
View(nested_other)
