countylandusedescription %in% midrise ~ "mid-rise",
countylandusedescription %in% parking ~ "parking",
countylandusedescription %in% stacked ~ "stacked",
countylandusedescription %in% coop ~ "co-op",
countylandusedescription %in% duplex ~ "duplex",
countylandusedescription %in% other ~ "other"))
rm(garden, highrise, midrise, parking, stacked, coop, duplex, other)
garden <- c("APARTMENT - GARDEN",
"SALES APPR CONDO/GARDEN")
highrise <- c("APARTMENT - HIGH-RISE",
"SALES APPR CONDO/HIGH RISE")
midrise <- c("SALES APPR CONDO/MID RISE",
"APARTMENT - MID-RISE")
parking <- c("APARTMENT - PARKING")
stacked <- c("SALES APPR CONDO/STACKED")
coop <- c("SALES APPR CONDO/CO-OP")
duplex <- c("RESIDENTIAL COST-VAL - DUPLEX")
other <- c("AFFORDABLE DWELLING UNIT",
"COMMUNITY BENEFIT UNIT",
"MULTI-FAM IMPR/NO SITE PLAN",
"MULTI-FAM IMPR/SITE PLAN",
"NOT VALUED CONDO HOA")
jur <- jur %>%
mutate(building_type = case_when(
countylandusedescription %in% garden ~ "garden",
countylandusedescription %in% highrise  ~ "high-rise",
countylandusedescription %in% midrise ~ "mid-rise",
countylandusedescription %in% parking ~ "parking",
countylandusedescription %in% stacked ~ "stacked",
countylandusedescription %in% coop ~ "co-op",
countylandusedescription %in% duplex ~ "duplex",
countylandusedescription %in% other ~ "other"))
rm(garden, highrise, midrise, parking, stacked, coop, duplex, other)
count(jur, lotsizeareaunit)
jur <- jur %>%
mutate(lotsize_acres = case_when(lotsizeareaunit == "AC" ~ lotsizeorarea ,
lotsizeareaunit == "SF" ~ lotsizeorarea / 43560),
lotsize_sf = lotsize_acres * 43560) %>%
mutate_at(vars(lotsize_acres, lotsize_sf), ~ replace(., .==0, NA))
jur <- jur %>%
mutate(parcel_address = substr(assessorsparcelnumberapnpin, 1, 6))
bad_parcels <- jur %>%
group_by(propaddress) %>%
summarize(parcel = list(parcel_address)) %>%
mutate(unq_parcels = as.integer(map(parcel,
function(x) length(unique(x))))) %>%
filter(unq_parcels > 1)
bad_addresses <- bad_parcels %>%
pull(propaddress)
jur <- jur %>%
mutate(parcel_address = ifelse(propaddress %in% bad_addresses,
NA,
parcel_address))
rm(bad_addresses, bad_parcels)
jur <- jur %>%
mutate(parcel_address = substr(assessorsparcelnumberapnpin, 1, 6))
View(jur)
bad_parcels <- jur %>%
group_by(propaddress) %>%
summarize(parcel = list(parcel_address))
View(bad_parcels)
s <- c(1, 2, 2)
length(s)
unique(length(s))
unique(s)
length(unique(x))
bad_parcels <- jur %>%
group_by(propaddress) %>%
summarize(parcel = list(parcel_address)) %>%
mutate(unq_parcels = as.integer(map(parcel,
function(x) length(unique(x))))) %>%
filter(unq_parcels > 1)
View(bad_parcels)
bad_addresses <- bad_parcels %>%
pull(propaddress)
x <- jur %>%
filter(residential == 1) %>%
group_by(propaddress) %>%
count() %>%
nrow()
y <- jur %>%
filter(residential == 1) %>%
group_by(propaddress, parcel_address) %>%
count() %>%
nrow()
if (x == y) {
print(paste0(x, " = ", y, ": clean collapse"))
} else if (y > x) {
warning("additional observations introduced")
}
jur <- jur %>%
mutate(parcel_address = ifelse(propaddress %in% bad_addresses,
NA,
parcel_address))
x <- jur %>%
filter(residential == 1) %>%
group_by(propaddress) %>%
count() %>%
nrow()
y <- jur %>%
filter(residential == 1) %>%
group_by(propaddress, parcel_address) %>%
count() %>%
nrow()
if (x == y) {
print(paste0(x, " = ", y, ": clean collapse"))
} else if (y > x) {
warning("additional observations introduced")
}
jur <- jur %>%
mutate(house_letter = ifelse(str_detect(prophouseno, "[:alpha:]") == 1, 1, 0),
oldadd = propaddress,
new_houseno = ifelse(house_letter == 1,
str_replace(prophouseno, "[:alpha:]", ""),
prophouseno),
propaddress = ifelse(house_letter == 1,
paste(str_replace_all(new_houseno, "-", ""),
propstreetname,
propstreetsuffix,
sep = " "),
propaddress))
jur %>%
filter(house_letter == 1) %>%
select(oldadd, propaddress, category_detail) %>%
head(20)
stopifnot(sum(is.na(jur$propaddress)) == nrow(filter(jur,
is.na(propaddress) | is.na(prophouseno))))
jur <- jur %>%
classify_addresses()
if (TRUE %in% is.na(jur$address_type)) {
warning("NAs in address_type")
}
jur <- jur %>%
mutate(address_type = ifelse(category_detail %in% c("townhouse", "sf attached"),
"single",
address_type))
multiples <- jur %>%
filter(address_type == "multiple")
singles <- jur %>%
filter(address_type == "single")
missing <- jur %>%
filter(address_type == "missing")
View(missing)
nested <- multiples %>%
group_by(propaddress, parcel_address) %>%
summarize_at(vars(zoning,lotsize_sf,
buildingarea, countylandusedescription,
residential, category, category_detail, building_type,
yearbuilt, long, lat), list)
View(nested)
nested <- multiples %>%
group_by(propaddress, parcel_address) %>%
summarize_at(vars(zoning,lotsize_sf,
buildingarea, countylandusedescription,
residential, category, category_detail, building_type,
yearbuilt, long, lat), list) %>%
rename_at(vars(-propaddress, -parcel_address), ~ paste0(., "_list")) %>%
mutate(nprops = map(zoning_list, length),
zoning = map(zoning_list, Mode),
lotsize_sf_sum = map_dbl(lotsize_sf_list, sum, na.rm = TRUE),
buildingarea = map_dbl(buildingarea_list, sum, na.rm = TRUE),
countylandusedescription = map(countylandusedescription_list, Mode),
residential = map(residential_list, max, na.rm = FALSE),
category = map(category_list, Mode),
category_detail = map(category_detail_list, Mode),
building_type = ifelse(category == "MF",
map(building_type_list, Mode),
NA),
long = map(long_list, median),
lat = map(lat_list, median),
# year built handled differently due to missing values
yearbuilt_list = ifelse(as.integer(map(yearbuilt_list, function(x) sum(!is.na(x)))) == 0,
NA,
yearbuilt_list),
yearbuilt = ifelse(!is.na(yearbuilt_list),
map(yearbuilt_list, max, na.rm = TRUE),
NA))
weird <- tibble(propaddress = c( "1330 S FAIR ST", "1633 N COLONIAL TER", "1117 N VERMONT ST", "1134 N STUART ST", "1300 N MEADE ST"),
instance = 1:5)
weird1 <- nested %>%
filter(propaddress %in% weird$propaddress) %>%
left_join(weird, by = "propaddress") %>%
select(instance, propaddress, nprops, lotsize_sf_list, lotsize_sf_sum) %>%
arrange(instance)
library(tidyverse)
source("../Macros/read-jurisdiction.R")
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
# knitr::opts_chunk$set(eval = FALSE)
library(tidyverse)
source("../Macros/read-jurisdiction.R")
if (!dir.exists("../Data")) {
dir.create("../Data")
}
currentfips <- "51013"
filepath <- "arlington"
if (!exists("jur")) {
jur <- read_jurisdiction(filepath)
} else {
warning(filepath, " data already read in")
}
vacant <- jur %>%
filter(category == "vacant")
vacant %>%
group_by(category_detail) %>%
summarize_at(vars(propaddress, lotsize_sf, zoning),
~ sum(is.na(.))) %>%
mutate_at(vars(propaddress, lotsize_sf, zoning),
.funs = funs(percent = scales::percent(. / nrow(vacant)))) %>%
knitr::kable(caption = "Number and percent of missing values")
if (!file.exists(paste0("L:/Libraries/RegHsg/Doc/zoning-codes/",
filepath,
"-zoning-code.csv"))) {
stop("Move zoning file for jurisdiction to L:/Libraries/RegHsg/Doc/zoning-codes directory")
}
z <- cols(
Code = col_character(),
`District Type` = col_character(),
`Type of Dwelling` = col_character(),
`Site Area` = col_number(),
`Lot area` = col_number(),
`Lot area per dwelling unit (sq. ft.) (minimum)` = col_number(),
`Lot Width (average minimum, ft)` = col_character(),
`Height (ft)` = col_double(),
`Height (stories)` = col_double(),
`Lot coverage maximum` = col_number(),
`Floor area minimum` = col_double(),
`Maximum Density of Floor-Area-Ratio (FAR)` = col_character(),
`Setbacks (centerline)` = col_character(),
`Setbacks (right of way line)` = col_double(),
`Front/Side yard (ft)` = col_double(),
`Side yard (both sides: minimum percent of required width)` = col_number(),
Frontage = col_double(),
Comments = col_character()
)
zoningcode <- read_csv(paste0("L:/Libraries/RegHsg/Doc/zoning-codes/",
filepath,
"-zoning-code.csv"),
col_types = z)
names(zoningcode) <-
c("zoning_code", "district_type", "dwelling_type",
"site_area", "lot_area", "lotarea_per_unit",
"lot_width", "height_ft", "height_stories",
"lot_coverage_max", "floor_area_min", "far_max",
"setbacks_center", "setbacks_row",
"front_side_yard", "side_yard", "frontage", "comments")
# fix variables read in as whole numbers (should be percent)
zoningcode <- zoningcode %>%
mutate_at(vars(lot_coverage_max, side_yard),
~ . / 100)
rm(z)
zoningcode %>%
count(dwelling_type) %>%
knitr::kable()
zoningcode <- zoningcode %>%
filter(!dwelling_type %in% c("All",
"All Other",
"Duplex; share a lot line with RA, C, or M",
"Semi-detatched; share a lot line with RA, C, or M"))
zoningcode <- zoningcode %>%
mutate(dwelling_type = factor(dwelling_type,
levels = c("Multiple-family",
"Townhouse",
"Duplex",
"Semi-detached",
"Other Residential",
"One Family Dwelling")))
vacant_zoning <- zoningcode %>%
group_by(zoning_code) %>%
slice(which.min(dwelling_type))
stopifnot(
length(unique(zoningcode$zoning_code)) == length(unique(vacant_zoning$zoning_code))
)
stopifnot(nrow(vacant_zoning) == nrow(count(vacant_zoning, zoning_code)))
vacant <- vacant %>%
mutate(zoning_code = ifelse(str_detect(zoning, "/") == TRUE,
NA,
zoning),
zoning_code = ifelse(zoning_code == "character(0)",
NA,
zoning_code),
zoning_code = ifelse(zoning_code == "RC",
"R-C",
zoning_code),
zoning_code = ifelse(zoning_code == "C-O-ROSSLYN",
"C-O Rosslyn",
zoning_code))
zoningdata <- left_join(vacant, vacant_zoning, by = "zoning_code")
anti_join(vacant, vacant_zoning, by = "zoning_code") %>%
count(zoning_code) %>%
knitr::kable()
missing_zoning <- vacant %>%
filter(is.na(zoning_code))
missing_zoning %>%
summarize(missing_addreess = sum(is.na(propaddress)),
zoning_tie = sum(str_detect(zoning, "/") == TRUE, na.rm = TRUE))
missing_zoning %>%
filter(!is.na(propaddress),
str_detect(zoning, "/") == FALSE) %>%
nrow()
count(zoningdata lotsize_sf > 7500)
count(zoningdata, lotsize_sf > 7500)
View(zoningdata)
count(zoningdata, lotsize_sf > lot_area)
count(zoningdata, lotsize_sf < lot_area)
count(zoningdata, lotsize_sf <= lot_area)
View(zoningcode)
View(zoningcode)
z <- cols(
Code = col_character(),
`District Type` = col_character(),
`Type of Dwelling` = col_character(),
`Site Area` = col_number(),
`Lot area` = col_number(),
`Lot area per dwelling unit (sq. ft.) (minimum)` = col_number(),
`Lot Width (average minimum, ft)` = col_character(),
`Height (ft)` = col_double(),
`Height (stories)` = col_double(),
`Lot coverage maximum` = col_number(),
`Floor area minimum` = col_double(),
`Maximum Density of Floor-Area-Ratio (FAR)` = col_character(),
`Setbacks (centerline)` = col_character(),
`Setbacks (right of way line)` = col_double(),
`Front/Side yard (ft)` = col_double(),
`Side yard (both sides: minimum percent of required width)` = col_number(),
Frontage = col_double(),
Comments = col_character()
)
zoningcode <- read_csv(paste0("L:/Libraries/RegHsg/Doc/zoning-codes/",
filepath,
"-zoning-code.csv"),
col_types = z)
names(zoningcode) <-
c("zoning_code", "district_type", "dwelling_type",
"site_area", "lot_area", "lotarea_per_unit",
"lot_width", "height_ft", "height_stories",
"lot_coverage_max", "floor_area_min", "far_max",
"setbacks_center", "setbacks_row",
"front_side_yard", "side_yard", "frontage", "comments")
# fix variables read in as whole numbers (should be percent)
zoningcode <- zoningcode %>%
mutate_at(vars(lot_coverage_max, side_yard),
~ . / 100)
rm(z)
zoningcode %>%
count(dwelling_type) %>%
knitr::kable()
zoningcode <- zoningcode %>%
filter(!dwelling_type %in% c("All",
"All Other",
"Duplex; share a lot line with RA, C, or M",
"Semi-detatched; share a lot line with RA, C, or M"))
zoningcode <- zoningcode %>%
mutate(dwelling_type = factor(dwelling_type,
levels = c("Multiple-family",
"Townhouse",
"Duplex",
"Semi-detached",
"Other Residential",
"One Family Dwelling")))
vacant <- vacant %>%
mutate(zoning_code = ifelse(str_detect(zoning, "/") == TRUE,
NA,
zoning),
zoning_code = ifelse(zoning_code == "character(0)",
NA,
zoning_code),
zoning_code = ifelse(zoning_code == "RC",
"R-C",
zoning_code),
zoning_code = ifelse(zoning_code == "C-O-ROSSLYN",
"C-O Rosslyn",
zoning_code))
zoningdata <- left_join(vacant, zoningcode, by = "zoning_code")
anti_join(vacant, vacant_zoning, by = "zoning_code") %>%
count(zoning_code) %>%
knitr::kable()
vacant <- vacant %>%
mutate(zoning_code = ifelse(str_detect(zoning, "/") == TRUE,
NA,
zoning),
zoning_code = ifelse(zoning_code == "character(0)",
NA,
zoning_code),
zoning_code = ifelse(zoning_code == "RC",
"R-C",
zoning_code),
zoning_code = ifelse(zoning_code == "C-O-ROSSLYN",
"C-O Rosslyn",
zoning_code),
zoning_code = ifelse(zoning_code == "RA-H-3.2",
"RA-H 3.2",
zoning_code))
zoningdata <- left_join(vacant, zoningcode, by = "zoning_code")
anti_join(vacant, vacant_zoning, by = "zoning_code") %>%
count(zoning_code) %>%
knitr::kable()
zoningdata1 <- zoningdata %>%
filter(lotsize_sf >= lot_area)
zoningdata1 <- zoningdata %>%
filter(lotsize_sf >= lot_area) %>%
group_by(zoning_code) %>%
slice(which.min(zoning_code))
View(zoningdata)
zoningdata1 <- zoningdata %>%
mutate(dwelling_type = factor(dwelling_type,
levels = c("Multiple-family",
"Duplex",
"Townhouse",
"Semi-detached",
"Other Residential",
"One Family Dwelling"))) %>%
filter(lotsize_sf >= lot_area) %>%
group_by(zoning_code) %>%
slice(which.min(zoning_code))
zoningdata1 <- zoningdata %>%
mutate(dwelling_type = factor(dwelling_type,
levels = c("Multiple-family",
"Duplex",
"Townhouse",
"Semi-detached",
"Other Residential",
"One Family Dwelling"))) %>%
filter(lotsize_sf >= lot_area) %>%
group_by(zoning_code) %>%
slice(which.min(dwelling_type))
View(zoningdata1)
zoningdata1 <- zoningdata %>%
mutate(dwelling_type = factor(dwelling_type,
levels = c("Multiple-family",
"Duplex",
"Townhouse",
"Semi-detached",
"Other Residential",
"One Family Dwelling"))) %>%
filter(lotsize_sf >= lot_area) %>%
group_by(dwelling_type) %>%
slice(which.min(dwelling_type))
zoningdata1 <- zoningdata %>%
mutate(dwelling_type = factor(dwelling_type,
levels = c("Multiple-family",
"Duplex",
"Townhouse",
"Semi-detached",
"Other Residential",
"One Family Dwelling"))) %>%
filter(lotsize_sf >= lot_area) %>%
group_by(propaddress) %>%
slice(which.min(dwelling_type))
View(zoningdata1)
zoningdata1 <- zoningdata %>%
mutate(dwelling_type = factor(dwelling_type,
levels = c("Multiple-family",
"Duplex",
"Townhouse",
"Semi-detached",
"Other Residential",
"One Family Dwelling"))) %>%
filter(lotsize_sf >= lot_area) %>%
# group_by(propaddress) %>%
slice(which.min(dwelling_type))
zoningdata1 <- zoningdata %>%
mutate(dwelling_type = factor(dwelling_type,
levels = c("Multiple-family",
"Duplex",
"Townhouse",
"Semi-detached",
"Other Residential",
"One Family Dwelling"))) %>%
filter(lotsize_sf >= lot_area) %>%
group_by(propaddress) %>%
slice(which.min(dwelling_type))
zoningdata1 <- zoningdata %>%
mutate(dwelling_type = factor(dwelling_type,
levels = c("Multiple-family",
"Duplex",
"Townhouse",
"Semi-detached",
"Other Residential",
"One Family Dwelling"))) %>%
filter(lotsize_sf >= lot_area)
zoningdata1 %>% group_by(propaddress) %>% count()
zoningdata1 <- zoningdata %>%
filter(lotsize_sf >= lot_area) %>%
group_by(propaddress) %>%
slice(which.min(dwelling_type))
View(zoningdata1)
zoningdata1 <- zoningdata %>%
filter(!is.na(lot_area),
lotsize_sf >= lot_area) %>%
group_by(propaddress) %>%
slice(which.min(dwelling_type))
zoningdata1 <- zoningdata %>%
filter(!is.na(lot_area),
lotsize_sf >= lot_area)
zoningdata %>% filter(!is.na(lot_area), lotsize_sf >= lot_area)
zoningdata %>% filter(!is.na(lot_area)) %>% count(lotsize_sf >= lot_area)
zoningdata1 <- zoningdata %>%
filter(!is.na(lot_area),
lotsize_sf >= lot_area) %>%
group_by(propaddress) %>%
slice(which.min(dwelling_type))
View(zoningdata1)
missing_zoning <- vacant %>%
filter(is.na(zoning_code))
missing_zoning %>%
summarize(missing_addreess = sum(is.na(propaddress)),
zoning_tie = sum(str_detect(zoning, "/") == TRUE, na.rm = TRUE))
missing_zoning %>%
summarize(missing_address = sum(is.na(propaddress)),
zoning_tie = sum(str_detect(zoning, "/") == TRUE, na.rm = TRUE))
View(missing_zoning)
